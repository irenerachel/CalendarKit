<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—¥å†å°åŠ©æ‰‹</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <script src="https://cdn.jsdelivr.net/npm/lunar-javascript/lunar.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&display=swap');
        @font-face { font-family: 'ç«™é…·ä»“è€³æ¸”é˜³ä½“'; src: url('fonts/ç«™é…·ä»“è€³æ¸”é˜³ä½“-W03.ttf'); }
        @font-face { font-family: 'éœé¹œæ–‡æ¥·'; src: url('fonts/LXGWWenKaiMono-Light.ttf'); }
        @font-face { font-family: 'å¾—æ„é»‘'; src: url('fonts/SmileySans-Oblique.otf'); }
        @font-face { font-family: 'æ±ŸåŸé»‘ä½“'; src: url('fonts/æ±ŸåŸé»‘ä½“ 300W.ttf'); }
        @font-face { font-family: 'é˜¿é‡Œå¦ˆå¦ˆæ–¹åœ†ä½“'; src: url('fonts/é˜¿é‡Œå¦ˆå¦ˆæ–¹åœ†ä½“.ttf'); }
        @font-face { font-family: 'é˜¿é‡Œå¦ˆå¦ˆæ•°é»‘ä½“'; src: url('fonts/é˜¿é‡Œå¦ˆå¦ˆæ•°é»‘ä½“.ttf'); }
        @font-face { font-family: 'å¯’è‰åŠåœ†ä½“'; src: url('fonts/å¯’è‰åŠåœ†ä½“.ttf'); }
        @font-face { font-family: 'é¸¿è’™é»‘ä½“'; src: url('fonts/é¸¿è’™é»‘ä½“.ttf'); }
        @font-face { font-family: 'èŠ±ä»¿å®‹'; src: url('fonts/èŠ±ä»¿å®‹.ttf'); }
        @font-face { font-family: 'è†å—åœ†ä½“'; src: url('fonts/è†å—åœ†ä½“.ttf'); }
        @font-face { font-family: 'ä¹ç±³æ³¢æ³¢ä½“'; src: url('fonts/ä¹ç±³æ³¢æ³¢ä½“.ttf'); }
        @font-face { font-family: 'æ€å°å®‹'; src: url('fonts/æ€å°å®‹.ttf'); }
        @font-face { font-family: 'é¦™èƒç­‰ç²—å®‹'; src: url('fonts/é¦™èƒç­‰ç²—å®‹.ttf'); }
        @font-face { font-family: 'æœ±é›€ä»¿å®‹'; src: url('fonts/æœ±é›€ä»¿å®‹.ttf'); }
        @font-face { font-family: 'å¤©ç‹æ˜Ÿåƒç´ '; src: url('fonts/Uranus_Pixel_11Px.ttf'); }
        @font-face { font-family: 'æ€æºé»‘ä½“'; src: url('fonts/æ€æºé»‘ä½“.otf'); }

        :root {
            --cream: #F8F5F0;
            --primary: #5D4E4A;
            --primary-light: #7D6E6A;
            --yellow: #E8D5B5;
            --yellow-light: #FFF8F0;
            --pink: #C49A9A;
            --green: #8FA587;
            --border: #E8E4DD;
            --calendar-font: 'é¸¿è’™é»‘ä½“';
            --cal-theme: #5D4E4A;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--cream);
            height: 100vh;
            overflow: hidden;
            color: var(--primary);
        }

        .navbar {
            background: white;
            border-bottom: 2px solid var(--primary);
            padding: 0 30px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .nav-brand {
            font-family: 'Playfair Display', serif;
            font-weight: 900;
            font-size: 20px;
        }
        .nav-center { display: flex; gap: 4px; }
        .nav-tab {
            padding: 6px 16px;
            font-size: 13px;
            border: 2px solid transparent;
            background: transparent;
            color: var(--primary);
            border-radius: 50px;
            cursor: pointer;
            font-family: inherit;
            font-weight: 500;
        }
        .nav-tab:hover { background: var(--yellow-light); }
        .nav-tab.active { background: var(--yellow); border-color: var(--primary); }
        .nav-btn {
            padding: 8px 20px;
            background: var(--primary);
            color: white;
            border: 2px solid var(--primary);
            border-radius: 50px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .follow-hint {
            position: relative;
            font-size: 10px;
            color: var(--primary-light);
            cursor: pointer;
            padding: 3px 6px;
            opacity: 0.7;
            white-space: nowrap;
            flex-shrink: 0;
        }
        .follow-hint:hover { opacity: 1; }
        .qrcode-popup {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 8px;
            padding: 10px;
            background: white;
            border-radius: 5px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.12);
            z-index: 1000;
        }
        .qrcode-popup img {
            width: 130px;
            height: 130px;
            border-radius: 5px;
            display: block;
        }
        .follow-hint:hover .qrcode-popup { display: block; }

        .main-layout {
            display: flex;
            height: calc(100vh - 60px);
        }

        .preview-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 30px 60px 30px;
            background: var(--cream);
            position: relative;
            overflow: hidden;
        }

        /* é¢„è§ˆåŒºå°ºå¯¸æ§åˆ¶ */
        .size-controls {
            position: absolute;
            top: 12px;
            left: 15px;
            display: flex;
            gap: 8px;
            align-items: center;
            background: white;
            padding: 8px 14px;
            border-radius: 10px;
            border: 2px solid var(--border);
            font-size: 12px;
            z-index: 10;
        }
        .size-controls label {
            color: var(--primary-light);
            font-weight: 500;
        }
        .size-controls input[type="number"] {
            width: 70px;
            padding: 5px 8px;
            border: 2px solid var(--border);
            border-radius: 6px;
            font-size: 12px;
            text-align: center;
        }
        .size-controls input:focus { border-color: var(--primary); outline: none; }
        .size-controls span { color: var(--primary-light); }

        /* å³ä¸Šè§’æç¤º */
        .tips-container {
            position: absolute;
            top: 22px;
            right: 30px;
            font-size: 11px;
            color: var(--primary-light);
            opacity: 0.5;
            transition: opacity 0.5s ease;
            max-width: 220px;
            text-align: right;
            pointer-events: none;
            z-index: 5;
            line-height: 1.4;
        }
        .tips-container.fade-out { opacity: 0; }
        .tips-container .tip-icon { margin-right: 4px; }
        .size-controls select {
            padding: 5px 8px;
            border: 2px solid var(--border);
            border-radius: 6px;
            font-size: 12px;
            background: white;
        }
        .size-slider {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            padding: 8px 14px;
            border: 2px solid var(--border);
            border-top: none;
            border-radius: 0 0 10px 10px;
            gap: 8px;
            align-items: center;
        }
        .size-slider.show { display: flex; }
        .size-history {
            position: absolute;
            top: 100%;
            left: 0;
            margin-top: 12px;
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
            max-width: 350px;
        }
        .size-history:empty { display: none; }
        .size-chip {
            padding: 3px 8px;
            background: var(--yellow);
            border: 1px solid var(--primary);
            border-radius: 4px;
            font-size: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            white-space: nowrap;
        }
        .size-chip:hover { background: var(--primary); color: white; }
        .size-chip .delete {
            font-size: 8px;
            opacity: 0.6;
            margin-left: 2px;
        }
        .size-chip .delete:hover { opacity: 1; }
        .size-slider input[type="range"] { flex: 1; accent-color: var(--primary); }
        .size-slider span { font-size: 11px; color: var(--primary-light); min-width: 30px; }

        /* é¢„è§ˆç¼©æ”¾æ§åˆ¶ */
        .zoom-controls {
            position: absolute;
            bottom: 12px;
            left: 15px;
            display: flex;
            gap: 8px;
            align-items: center;
            background: white;
            padding: 6px 12px;
            border-radius: 8px;
            border: 2px solid var(--border);
            font-size: 11px;
            z-index: 10;
        }
        .zoom-controls label { color: var(--primary-light); font-weight: 500; }
        .zoom-controls input[type="range"] {
            width: 100px;
            accent-color: var(--primary);
        }
        .zoom-controls span { color: var(--primary); font-weight: 600; min-width: 36px; }

        .mascot-watermark {
            position: absolute;
            bottom: -20px;
            right: 30px;
            width: 140px;
            height: auto;
            opacity: 0.1;
            filter: grayscale(30%);
            pointer-events: none;
            z-index: 2;
        }

        .control-panel {
            width: 480px;
            background: white;
            border-left: 2px solid var(--primary);
            padding: 16px 20px;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .panel-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px 14px;
            align-content: start;
            flex: 1;
        }

        .section {
            padding: 12px;
            background: linear-gradient(135deg, #FDFCFA 0%, #F8F5F0 100%);
            border: 1px solid var(--border);
            border-radius: 8px;
        }
        .section.full-width { grid-column: 1 / -1; }
        .section.date-section {
            grid-column: 1 / -1;
            background: none;
            border: none;
            padding: 0 0 8px 0;
            border-bottom: 1px dashed var(--border);
            border-radius: 0;
        }
        .section-title {
            font-size: 10px;
            font-weight: 600;
            color: var(--primary-light);
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .form-row { display: flex; gap: 8px; margin-bottom: 8px; }
        .form-row:last-child { margin-bottom: 0; }
        .form-item { flex: 1; }
        .form-label { font-size: 9px; color: var(--primary-light); margin-bottom: 3px; display: block; }
        select, input[type="number"], input[type="text"] {
            width: 100%;
            padding: 6px 8px;
            border: 2px solid var(--border);
            border-radius: 6px;
            font-size: 12px;
            font-family: inherit;
            background: white;
            color: var(--primary);
            outline: none;
        }
        select {
            padding-right: 24px;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%235D4E4A' d='M2 4l4 4 4-4'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 8px center;
        }
        select:focus, input:focus { border-color: var(--primary); }

        /* è‡ªå®šä¹‰å­—ä½“ä¸‹æ‹‰æ¡† */
        .custom-select-wrap {
            position: relative;
            width: 100%;
        }
        .custom-select-trigger {
            width: 100%;
            padding: 6px 8px;
            padding-right: 28px;
            border: 2px solid var(--border);
            border-radius: 6px;
            font-size: 12px;
            background: white;
            color: var(--primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: border-color 0.2s;
        }
        .custom-select-trigger:hover { border-color: var(--primary-light); }
        .custom-select-trigger.active { border-color: var(--primary); }
        .custom-select-trigger svg {
            position: absolute;
            right: 8px;
            color: var(--primary);
            transition: transform 0.2s;
        }
        .custom-select-trigger.active svg { transform: rotate(180deg); }
        .custom-select-dropdown {
            display: none;
            position: absolute;
            top: calc(100% + 4px);
            left: 0;
            right: 0;
            background: white;
            border: 2px solid var(--primary);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(93, 78, 74, 0.15);
            max-height: 240px;
            overflow-y: auto;
            z-index: 100;
        }
        .custom-select-dropdown.show { display: block; }
        .custom-select-option {
            padding: 8px 12px;
            font-size: 12px;
            color: var(--primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: background 0.15s;
        }
        .custom-select-option:first-child { border-radius: 6px 6px 0 0; }
        .custom-select-option:last-child { border-radius: 0 0 6px 6px; }
        .custom-select-option:hover { background: var(--yellow-light); }
        .custom-select-option.selected { background: var(--yellow); font-weight: 600; }
        .recommend-tag {
            font-size: 9px;
            padding: 1px 5px;
            background: var(--pink);
            color: white;
            border-radius: 3px;
            font-weight: 500;
        }
        .custom-select-dropdown::-webkit-scrollbar { width: 6px; }
        .custom-select-dropdown::-webkit-scrollbar-track { background: var(--cream); border-radius: 3px; }
        .custom-select-dropdown::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
        .custom-select-dropdown::-webkit-scrollbar-thumb:hover { background: var(--primary-light); }

        .pill-group { display: flex; flex-wrap: wrap; gap: 5px; align-items: center; }
        .custom-ratio-wrap {
            display: flex;
            align-items: center;
            gap: 3px;
            margin-left: 4px;
            padding-left: 8px;
            border-left: 1px dashed var(--border);
        }
        .custom-ratio-wrap input[type="number"] {
            border: 1px solid var(--border);
            border-radius: 4px;
        }
        .ratio-slider {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            width: 160px;
            background: white;
            padding: 6px 10px;
            border: 2px solid var(--border);
            border-radius: 8px;
            margin-top: 4px;
            gap: 6px;
            align-items: center;
            z-index: 10;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .ratio-slider.show { display: flex; }
        .ratio-slider input[type="range"] { flex: 1; min-width: 0; width: 80px; accent-color: var(--primary); }
        .ratio-slider span { font-size: 10px; color: var(--primary-light); flex-shrink: 0; }
        .pill-btn {
            padding: 5px 10px;
            font-size: 11px;
            border: 1px solid var(--border);
            background: white;
            border-radius: 50px;
            cursor: pointer;
            font-family: inherit;
            font-weight: 500;
            color: var(--primary);
        }
        .pill-btn:hover { border-color: var(--primary); background: var(--yellow-light); }
        .pill-btn.active { background: var(--yellow); border-color: var(--primary); }
        .pill-btn:disabled { opacity: 0.3; cursor: not-allowed; }

        .btn-grid { display: grid; gap: 5px; }
        .btn-grid.cols-2 { grid-template-columns: repeat(2, 1fr); }
        .btn-grid.cols-3 { grid-template-columns: repeat(3, 1fr); }
        .grid-btn {
            padding: 7px;
            font-size: 11px;
            border: 2px solid var(--border);
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-family: inherit;
            font-weight: 500;
            color: var(--primary);
        }
        .grid-btn:hover { border-color: var(--primary); background: var(--yellow-light); }
        .grid-btn.active { background: var(--yellow); border-color: var(--primary); }

        .color-row { display: flex; gap: 5px; align-items: center; flex-wrap: wrap; }
        .color-btn {
            width: 24px; height: 24px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
        }
        .color-btn:hover { transform: scale(1.1); }
        .color-btn.active { border-color: var(--primary); box-shadow: 0 0 0 2px var(--yellow); }
        .color-picker-wrap {
            display: flex;
            align-items: center;
            gap: 4px;
            margin-left: 4px;
            padding-left: 8px;
            border-left: 1px dashed var(--border);
        }
        .color-picker-wrap input[type="color"] {
            width: 24px; height: 24px;
            border: 2px dashed var(--primary-light);
            border-radius: 50%;
            padding: 0;
            cursor: pointer;
            background: none;
        }
        .color-picker-wrap input[type="color"]::-webkit-color-swatch-wrapper { padding: 2px; }
        .color-picker-wrap input[type="color"]::-webkit-color-swatch { border-radius: 50%; border: none; }
        .color-picker-label {
            font-size: 8px;
            color: var(--primary-light);
            writing-mode: vertical-rl;
            letter-spacing: 1px;
        }
        .saved-colors {
            display: flex;
            gap: 5px;
            margin-top: 8px;
            flex-wrap: wrap;
        }
        .saved-colors:empty { display: none; }
        .saved-colors:empty + .saved-colors-hint { display: none; }
        .saved-colors-hint {
            font-size: 9px;
            color: var(--primary-light);
            opacity: 0.6;
            margin-top: 4px;
        }
        .saved-color {
            width: 22px; height: 22px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            position: relative;
            transition: transform 0.15s;
        }
        .saved-color:hover { transform: scale(1.1); }
        .saved-color.active { border-color: var(--primary); box-shadow: 0 0 0 2px var(--yellow); }
        .saved-color.deleting::after {
            content: 'Ã—';
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 14px;
            font-weight: bold;
            text-shadow: 0 0 2px rgba(0,0,0,0.5);
        }

        .upload-box {
            border: 2px dashed var(--border);
            border-radius: 10px;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            background: var(--yellow-light);
        }
        .upload-box:hover { border-color: var(--primary); }
        .upload-box.has-image { border-style: solid; border-color: var(--primary); padding: 6px; background: white; }
        .upload-box input { display: none; }
        .upload-box .icon { font-size: 24px; }
        .upload-box .text { font-size: 10px; color: var(--primary-light); margin-top: 4px; }
        .upload-box img { max-width: 100%; max-height: 40px; border-radius: 4px; }
        .upload-actions { display: flex; gap: 4px; margin-top: 6px; justify-content: center; }
        .bg-opacity-row { display: flex; gap: 8px; align-items: center; margin-top: 8px; }

        /* è®¾ç½®ä¿å­˜åŒºåŸŸ */
        .settings-save-section { margin-top: auto; }
        .settings-row {
            display: flex;
            gap: 6px;
            align-items: center;
        }
        .settings-row select {
            flex: 1;
        }
        .settings-select-wrap {
            flex: 1;
        }
        .settings-select-wrap .custom-select-dropdown {
            max-height: 180px;
        }
        .settings-placeholder {
            color: var(--primary-light);
            font-style: italic;
        }
        .settings-btn {
            padding: 6px 10px;
            border: 2px solid var(--border);
            border-radius: 6px;
            background: white;
            cursor: pointer;
            font-size: 14px;
        }
        .settings-tip {
            margin-top: 8px;
            font-size: 10px;
            color: var(--pink);
            background: var(--yellow-light);
            padding: 6px 10px;
            border-radius: 6px;
            line-height: 1.4;
        }
        .settings-btn:hover { border-color: var(--primary); background: var(--yellow-light); }
        .settings-btn.delete:hover { background: #FEE2E2; border-color: #B91C1C; }

        /* ä¿å­˜è®¾ç½®å¯¹è¯æ¡† */
        .save-dialog-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.4);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .save-dialog-overlay.show { display: flex; }
        .save-dialog {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            min-width: 300px;
        }
        .save-dialog h3 {
            margin: 0 0 12px 0;
            font-size: 14px;
            color: var(--primary);
        }
        .save-dialog input {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 13px;
            margin-bottom: 12px;
        }
        .save-dialog input:focus { border-color: var(--primary); outline: none; }
        .save-dialog-btns {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }
        .save-dialog-btns button {
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            border: 2px solid var(--primary);
        }
        .save-dialog-btns .cancel { background: white; color: var(--primary); }
        .save-dialog-btns .confirm { background: var(--primary); color: white; }
        .upload-actions button {
            padding: 3px 10px; font-size: 9px; border: 2px solid var(--primary);
            border-radius: 50px; cursor: pointer; font-weight: 600;
        }
        .upload-actions .change-btn { background: white; color: var(--primary); }
        .upload-actions .delete-btn { background: #FEE2E2; color: #B91C1C; border-color: #B91C1C; }


        /* ç”»å¸ƒå®¹å™¨ */
        .canvas-container {
            position: relative;
            display: inline-block;
            flex-shrink: 0;
        }

        /* ç”»å¸ƒé¢„è§ˆåŒºåŸŸé™åˆ¶ */
        .canvas-wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
            flex: 1;
            width: 100%;
            max-height: 100%;
            overflow: visible;
            z-index: 1;
        }

        .resize-handle {
            position: absolute;
            background: var(--yellow);
            border: 2px solid var(--primary);
            z-index: 100;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .canvas-container:hover .resize-handle { opacity: 1; }
        .resize-handle.corner { width: 10px; height: 10px; border-radius: 50%; }
        .resize-handle.edge { background: var(--primary); border-radius: 2px; }
        .resize-handle.right { right: -5px; top: 50%; transform: translateY(-50%); width: 5px; height: 36px; cursor: e-resize; }
        .resize-handle.bottom { bottom: -5px; left: 50%; transform: translateX(-50%); width: 36px; height: 5px; cursor: s-resize; }
        .resize-handle.bottom-right { bottom: -5px; right: -5px; cursor: se-resize; }

        .resize-hint {
            position: absolute;
            bottom: -22px;
            right: 0;
            font-size: 10px;
            color: var(--primary-light);
            opacity: 0;
            transition: opacity 0.2s;
            white-space: nowrap;
        }
        .canvas-container:hover .resize-hint { opacity: 0.7; }

        .resize-tooltip {
            position: fixed;
            background: var(--primary);
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            pointer-events: none;
            z-index: 1000;
            display: none;
            white-space: nowrap;
        }
        .resize-tooltip.show { display: block; }

        /* æ—¥å†å¡ç‰‡ */
        .calendar-card {
            background: white;
            overflow: hidden;
            display: flex;
            position: relative;
            border: 2px solid var(--cal-theme);
        }

        .calendar-card.horizontal { flex-direction: row; }
        .calendar-card.horizontal .image-section { width: 35%; flex-shrink: 0; }
        .calendar-card.horizontal .calendar-section { width: 65%; flex-shrink: 0; }
        .calendar-card.horizontal[data-pos="left"] { flex-direction: row; }
        .calendar-card.horizontal[data-pos="right"] { flex-direction: row-reverse; }

        .calendar-card.vertical { flex-direction: column; }
        .calendar-card.vertical .image-section { height: 35%; flex-shrink: 0; }
        .calendar-card.vertical .calendar-section { flex: 1; }
        .calendar-card.vertical[data-pos="top"] { flex-direction: column; }
        .calendar-card.vertical[data-pos="bottom"] { flex-direction: column-reverse; }

        .calendar-card[data-pos="none"] .image-section { display: none; }
        .calendar-card[data-pos="none"] .calendar-section { flex: 1; height: 100%; }

        .bg-layer {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            z-index: 0;
            overflow: hidden;
            opacity: var(--bg-opacity, 0.3);
            pointer-events: none;
        }
        .bg-layer img {
            position: absolute;
            top: 50%; left: 50%;
            min-width: 100%;
            min-height: 100%;
            width: auto;
            height: auto;
            pointer-events: none;
            user-select: none;
            transform-origin: center center;
        }
        .bg-layer .bg-hint {
            position: absolute;
            bottom: calc(8px * var(--cal-scale, 1));
            right: calc(8px * var(--cal-scale, 1));
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(4px);
            color: white;
            padding: calc(4px * var(--cal-scale, 1)) calc(10px * var(--cal-scale, 1));
            border-radius: calc(20px * var(--cal-scale, 1));
            font-size: calc(10px * var(--cal-scale, 1));
            font-weight: 500;
            letter-spacing: 0.5px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 10;
            white-space: nowrap;
        }
        .calendar-card.has-bg:hover .bg-hint { opacity: 0.9; }

        .image-section {
            position: relative;
            z-index: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            background: var(--yellow-light);
            cursor: move;
        }
        .image-section.has-bg { background: transparent; }
        .image-section.drag-over { outline: 3px dashed var(--primary); outline-offset: -4px; }
        .image-section.dragging { cursor: grabbing; }
        .image-section img {
            position: absolute;
            top: 50%; left: 50%;
            width: auto;
            height: auto;
            max-width: none;
            max-height: none;
            pointer-events: none;
            user-select: none;
            transform-origin: center center;
        }
        .image-section .placeholder {
            color: var(--primary-light);
            font-size: calc(12px * var(--cal-scale, 1));
            text-align: center;
            padding: calc(12px * var(--cal-scale, 1));
            cursor: pointer;
        }
        .image-section .placeholder .icon { font-size: calc(32px * var(--cal-scale, 1)); margin-bottom: calc(6px * var(--cal-scale, 1)); opacity: 0.5; }
        .image-section .placeholder .sub { font-size: calc(10px * var(--cal-scale, 1)); margin-top: calc(4px * var(--cal-scale, 1)); opacity: 0.6; }

        .image-hint {
            position: absolute;
            bottom: calc(8px * var(--cal-scale, 1));
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(4px);
            color: white;
            padding: calc(4px * var(--cal-scale, 1)) calc(10px * var(--cal-scale, 1));
            border-radius: calc(20px * var(--cal-scale, 1));
            font-size: calc(10px * var(--cal-scale, 1));
            font-weight: 500;
            letter-spacing: 0.5px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            white-space: nowrap;
            z-index: 10;
        }
        .image-section:hover .image-hint { opacity: 0.9; }

        .calendar-section {
            position: relative;
            z-index: 1;
            padding: calc(14px * var(--cal-scale, 1)) calc(12px * var(--cal-scale, 1)) calc(10px * var(--cal-scale, 1));
            font-family: var(--calendar-font), sans-serif;
            background: white;
            display: flex;
            flex-direction: column;
        }
        .calendar-card.has-bg .calendar-section { background: rgba(255,255,255,0.85); }
        .calendar-card.has-bg .image-section { background: transparent; }

        .calendar-header { text-align: center; margin-bottom: calc(24px * var(--cal-scale, 1)); padding-top: calc(12px * var(--cal-scale, 1)); }
        .calendar-section.has-divider .month-grid,
        .calendar-section.has-divider .week-grid {
            position: relative;
            padding-top: calc(12px * var(--cal-scale, 1));
        }
        .calendar-section.has-divider .month-grid::before,
        .calendar-section.has-divider .week-grid::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: var(--divider-thickness, 1px);
            background: color-mix(in srgb, var(--cal-theme) 25%, transparent);
        }
        .calendar-header .year-month {
            font-family: var(--calendar-font), sans-serif;
            font-size: calc(26px * var(--cal-scale, 1));
            color: var(--cal-theme);
            font-weight: 700;
        }
        .calendar-header .lunar-month {
            display: none;
        }

        .month-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            flex: 1;
        }
        .weekday-header {
            text-align: center;
            font-size: calc(9px * var(--cal-scale, 1));
            font-weight: 600;
            color: var(--cal-theme);
            opacity: 0.6;
            padding: calc(3px * var(--cal-scale, 1)) 0;
        }
        .weekday-header.weekend { color: var(--pink); opacity: 1; }

        .day-cell {
            text-align: center;
            padding: 2px 1px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 3px;
        }
        .day-cell.other-month { opacity: 0.15; }
        .day-cell.weekend { color: var(--pink); }
        .day-cell .solar { font-size: calc(12px * var(--cal-scale, 1)); font-weight: 600; color: var(--cal-theme); }
        .day-cell .lunar { font-size: calc(7px * var(--cal-scale, 1)); color: var(--cal-theme); opacity: 0.5; margin-top: calc(1px * var(--cal-scale, 1)); }
        .day-cell .lunar.festival { color: var(--pink) !important; font-weight: 600; }
        .day-cell .lunar.jieqi { color: var(--green) !important; }

        .solar-only .day-cell .lunar { display: none; }
        .solar-only .calendar-header .lunar-month { display: none; }

        .note-style .month-grid { gap: 0; }
        .note-style .weekday-header { border-bottom: 1px solid var(--border); padding: 3px 0; }
        .note-style .day-cell {
            border: 1px solid var(--border);
            border-radius: 0;
            padding: 0;
            align-items: flex-start;
            justify-content: flex-start;
            position: relative;
            aspect-ratio: 1;
        }
        .note-style .day-cell .solar {
            position: absolute;
            top: calc(2px * var(--cal-scale, 1));
            left: calc(3px * var(--cal-scale, 1));
            font-size: calc(10px * var(--cal-scale, 1));
        }
        .note-style .day-cell .lunar { display: none; }
        .note-style .day-cell .note-input {
            position: absolute;
            bottom: 1px;
            left: 1px;
            right: 1px;
            font-size: 6px;
            border: none;
            background: transparent;
            text-align: center;
            color: var(--cal-theme);
            opacity: 0.7;
            outline: none;
            padding: 0;
        }
        .note-style .calendar-header .lunar-month { display: none; }

        .card-footer {
            text-align: center;
            padding-top: calc(5px * var(--cal-scale, 1));
            font-size: calc(7px * var(--cal-scale, 1));
            color: var(--cal-theme);
            opacity: 0.5;
            flex-shrink: 0;
        }

        .week-grid { display: flex; flex-direction: column; gap: calc(4px * var(--cal-scale, 1)); flex: 1; }
        .calendar-section:has(.week-grid) .calendar-header { margin-bottom: calc(20px * var(--cal-scale, 1)); }
        .week-day-row {
            display: flex;
            align-items: center;
            padding: calc(6px * var(--cal-scale, 1)) calc(10px * var(--cal-scale, 1));
            background: color-mix(in srgb, var(--cal-theme) 8%, white);
            gap: 6px;
            border-radius: calc(6px * var(--cal-scale, 1));
            flex: 1;
        }
        .week-day-row.weekend { background: #FFF0F3; }
        .week-day-name { font-size: calc(11px * var(--cal-scale, 1)); font-weight: 600; width: calc(28px * var(--cal-scale, 1)); color: var(--cal-theme); }
        .week-solar { font-size: calc(14px * var(--cal-scale, 1)); font-weight: 700; width: calc(22px * var(--cal-scale, 1)); color: var(--cal-theme); }
        .week-lunar { font-size: calc(10px * var(--cal-scale, 1)); color: var(--cal-theme); opacity: 0.6; flex: 1; }

        /* å¹³æ¿é€‚é… */
        @media (max-width: 1000px) {
            .main-layout { flex-direction: column-reverse; height: auto; overflow: auto; }
            .control-panel { width: 100%; border-left: none; border-top: 2px solid var(--primary); max-height: 50vh; overflow-y: auto; }
            .preview-area { min-height: 350px; }
            body { overflow: auto; }
        }

        /* æ‰‹æœºé€‚é… */
        @media (max-width: 768px) {
            .navbar {
                padding: 0 12px;
                height: 50px;
                flex-wrap: wrap;
            }
            .nav-brand { font-size: 16px; }
            .nav-tab { padding: 4px 10px; font-size: 11px; }
            .nav-btn { padding: 6px 12px; font-size: 11px; }
            .navbar > div:last-child {
                gap: 6px !important;
            }
            .navbar select { font-size: 11px; padding: 4px 8px; min-width: 60px !important; }

            .main-layout { flex-direction: column-reverse; }
            .control-panel {
                width: 100%;
                padding: 12px;
                max-height: 55vh;
            }
            .panel-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            .section { padding: 10px; }
            .section-title { font-size: 11px; }

            .preview-area {
                padding: 50px 15px 60px 15px;
                min-height: 300px;
            }
            .size-controls {
                top: 8px;
                left: 8px;
                padding: 6px 10px;
                font-size: 11px;
                flex-wrap: wrap;
                max-width: calc(100% - 16px);
            }
            .size-controls input[type="number"] { width: 55px; }
            .zoom-controls {
                bottom: 8px;
                left: 8px;
                padding: 5px 10px;
                font-size: 10px;
            }
            .zoom-controls input[type="range"] { width: 80px; }
            .tips-container {
                top: 8px;
                right: 12px;
                font-size: 10px;
                max-width: 140px;
            }

            .pill-btn { padding: 4px 8px; font-size: 10px; }
            .grid-btn { padding: 5px; font-size: 10px; }
            .color-btn { width: 20px; height: 20px; }

            .upload-box { padding: 10px; }
            .upload-box .icon { font-size: 20px; }
            .upload-box .text { font-size: 11px; }

            .custom-select-trigger { padding: 5px 8px; font-size: 11px; }
            .custom-select-option { padding: 10px 12px; font-size: 12px; }
            .custom-select-dropdown { max-height: 200px; }

            .save-dialog { width: 90%; min-width: auto; padding: 16px; }
            .save-dialog h3 { font-size: 14px; }

            .settings-row { flex-wrap: wrap; gap: 6px; }
            .settings-row select { flex: 1; min-width: 120px; }
            .settings-btn { padding: 5px 8px; font-size: 12px; }
            .settings-tip { font-size: 9px; }
        }

        /* å°å±æ‰‹æœºé€‚é… */
        @media (max-width: 480px) {
            .navbar {
                height: auto;
                padding: 8px 10px;
                gap: 8px;
            }
            .nav-brand {
                width: 100%;
                text-align: center;
                font-size: 14px;
            }
            .nav-center {
                order: 1;
                flex: 1;
            }
            .navbar > div:last-child {
                order: 2;
                flex-wrap: wrap;
                justify-content: center;
            }

            .panel-grid { gap: 8px; }
            .section { padding: 8px; }

            .form-row { flex-direction: column; gap: 6px; }
            .form-item { width: 100%; }

            .pill-group { gap: 4px; }
            .btn-grid.cols-3 { grid-template-columns: repeat(2, 1fr); }

            .color-row { gap: 4px; }
            .color-picker-wrap { margin-left: 2px; padding-left: 6px; }

            .size-controls {
                position: relative;
                top: auto;
                left: auto;
                margin: 0 0 10px 0;
                width: 100%;
                border-radius: 8px;
            }
            .preview-area {
                padding: 15px 10px 50px 10px;
                flex-direction: column;
            }
            .zoom-controls {
                position: relative;
                bottom: auto;
                left: auto;
                margin-top: 10px;
                width: 100%;
                justify-content: center;
            }
            .tips-container {
                position: relative;
                top: auto;
                right: auto;
                text-align: center;
                max-width: 100%;
                margin-bottom: 8px;
            }
        }

        /* è§¦æ‘¸è®¾å¤‡ä¼˜åŒ– */
        @media (hover: none) and (pointer: coarse) {
            .pill-btn, .grid-btn, .color-btn, .nav-tab, .nav-btn, .settings-btn {
                min-height: 36px;
                min-width: 36px;
            }
            .custom-select-option {
                padding: 12px 14px;
                min-height: 44px;
            }
            .image-hint, .bg-hint {
                font-size: 11px !important;
                padding: 6px 10px !important;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-brand">Calendar Studio</div>
        <div class="nav-center">
            <button class="nav-tab active" data-type="month" onclick="changeType(this)">æœˆå†</button>
            <button class="nav-tab" data-type="week" onclick="changeType(this)">å‘¨å†</button>
        </div>
        <div style="display:flex;gap:10px;align-items:center;flex-shrink:0;">
            <div class="follow-hint">
                <span>@é˜¿çœŸIrene</span>
                <div class="qrcode-popup">
                    <img src="qrcode.jpg" alt="äºŒç»´ç ">
                </div>
            </div>
            <select id="exportFormat" style="padding:6px 24px 6px 12px;border:2px solid var(--border);border-radius:6px;font-size:12px;min-width:80px;" title="å¯¼å‡ºæ ¼å¼">
                <option value="png">PNG</option>
                <option value="jpeg">JPG</option>
                <option value="svg">SVG</option>
            </select>
            <select id="exportScale" style="padding:6px 12px;border:2px solid var(--border);border-radius:6px;font-size:12px;min-width:100px;" title="å¯¼å‡ºå€ç‡">
                <option value="1">1x åŸå›¾</option>
                <option value="2">2x å±å¹•</option>
                <option value="3" selected>3x é«˜æ¸…</option>
                <option value="4">4x å°åˆ·</option>
                <option value="6">6x å¤§å¹…</option>
                <option value="8">8x è¶…æ¸…</option>
            </select>
            <button class="nav-btn" onclick="exportImage()">å¯¼å‡ºå›¾ç‰‡</button>
        </div>
    </nav>

    <div class="main-layout">
        <div class="preview-area">
            <div class="tips-container" id="tipsContainer">
                <span class="tip-icon">ğŸ’¡</span><span id="tipText">å†…å®¹è¶…å‡ºåˆ«æ‹…å¿ƒï¼Œè°ƒæ•´å­—ä½“å¤§å°å³å¯</span>
            </div>
            <div class="size-controls">
                <label>ç”»å¸ƒ</label>
                <select id="sizePreset" onchange="applyPreset()" style="padding:5px 8px;font-size:11px;">
                    <option value="">é¢„è®¾å°ºå¯¸</option>
                </select>
                <input type="number" id="widthInput" value="390" min="100" max="3000" step="10" onchange="updateSizeFromInput()" onfocus="showSlider('width')" onblur="hideSlider('width')">
                <span>Ã—</span>
                <input type="number" id="heightInput" value="520" min="100" max="2000" step="10" onchange="updateSizeFromInput()" onfocus="showSlider('height')" onblur="hideSlider('height')">
                <select id="sizeUnit" onchange="changeSizeUnit()">
                    <option value="px">px</option>
                    <option value="cm">cm</option>
                </select>
                <button onclick="resetToDefault()" style="padding:4px 8px;border:2px solid var(--border);border-radius:6px;background:white;font-size:14px;cursor:pointer;color:var(--primary);" title="æ¢å¤é»˜è®¤è®¾ç½®">â†º</button>
                <button onclick="saveCurrentSize()" style="padding:4px 10px;border:2px solid var(--border);border-radius:6px;background:var(--yellow-light);font-size:11px;cursor:pointer;color:var(--primary);" title="ä¿å­˜å½“å‰å°ºå¯¸">ğŸ’¾</button>
                <span style="border-left:1px solid var(--border);height:20px;margin:0 4px;"></span>
                <button id="undoBtn" onclick="undo()" style="padding:4px 8px;border:2px solid var(--border);border-radius:6px;background:white;font-size:12px;cursor:pointer;color:var(--primary);opacity:0.4;" title="æ’¤å›ä¸Šä¸€æ­¥" disabled>â†</button>
                <button id="redoBtn" onclick="redo()" style="padding:4px 8px;border:2px solid var(--border);border-radius:6px;background:white;font-size:12px;cursor:pointer;color:var(--primary);opacity:0.4;" title="é‡åšä¸‹ä¸€æ­¥" disabled>â†’</button>
                <div class="size-history" id="sizeHistory"></div>
                <div class="size-slider" id="widthSliderWrap">
                    <span>å®½</span>
                    <input type="range" id="widthSlider" min="200" max="1500" value="390" step="10" oninput="updateFromSlider('width')">
                </div>
                <div class="size-slider" id="heightSliderWrap">
                    <span>é«˜</span>
                    <input type="range" id="heightSlider" min="200" max="1500" value="520" step="10" oninput="updateFromSlider('height')">
                </div>
            </div>

            <div class="zoom-controls">
                <label>æ˜¾ç¤º</label>
                <input type="range" id="previewZoom" min="10" max="200" value="100" oninput="updatePreviewZoom()">
                <span id="zoomValue">100%</span>
            </div>

            <img src="mascot.png" class="mascot-watermark" alt="">

            <div class="canvas-wrapper">
                <div class="canvas-container" id="canvasContainer">
                    <div class="calendar-card vertical" id="calendarCard" data-pos="bottom">
                        <div class="bg-layer" id="bgLayer"></div>
                        <div class="image-section" id="imageSection">
                            <div class="placeholder">
                                <div class="icon">ğŸ–¼ï¸</div>
                                <div>ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡</div>
                                <div class="sub">æ‹–æ‹½ç§»åŠ¨ Â· æ»šè½®ç¼©æ”¾</div>
                            </div>
                        </div>
                        <div class="calendar-section" id="calendarSection">
                            <div class="calendar-header">
                                <div class="year-month" id="yearMonthDisplay"></div>
                                <div class="lunar-month" id="lunarMonthDisplay"></div>
                            </div>
                            <div id="calendarGrid"></div>
                            <div class="card-footer" id="cardFooter">æ—¥å†å°åŠ©æ‰‹</div>
                        </div>
                    </div>
                    <div class="resize-handle edge right" data-dir="e"></div>
                    <div class="resize-handle edge bottom" data-dir="s"></div>
                    <div class="resize-handle corner bottom-right" data-dir="se"></div>
                    <div class="resize-hint">â†˜ æ‹–æ‹½è¾¹ç¼˜è‡ªç”±è°ƒæ•´å¤§å°</div>
                </div>
            </div>
            <div class="resize-tooltip" id="resizeTooltip"></div>
        </div>

        <!-- ä¿å­˜è®¾ç½®å¯¹è¯æ¡† -->
        <div class="save-dialog-overlay" id="saveDialogOverlay" onclick="closeSaveDialog(event)">
            <div class="save-dialog" onclick="event.stopPropagation()">
                <h3>ä¿å­˜å½“å‰è®¾ç½®</h3>
                <input type="text" id="settingsName" placeholder="è¾“å…¥è®¾ç½®åç§°ï¼Œå¦‚ï¼šå°çº¢ä¹¦ç«–ç‰ˆ" maxlength="20">
                <div class="save-dialog-btns">
                    <button class="cancel" onclick="closeSaveDialog()">å–æ¶ˆ</button>
                    <button class="confirm" onclick="confirmSaveSettings()">ä¿å­˜</button>
                </div>
            </div>
        </div>

        <div class="control-panel">
            <div class="panel-grid">
                <div class="section date-section">
                    <div class="section-title">âœ¦ æ—¥æœŸ</div>
                    <div style="display:flex;gap:8px;align-items:flex-end;">
                        <div class="form-item" style="flex:1;">
                            <input type="number" id="year" min="1900" max="2100" onchange="updateCalendar()">
                        </div>
                        <div class="form-item" style="flex:1;">
                            <select id="month" onchange="updateCalendar()"></select>
                        </div>
                        <div class="form-item" id="weekSelector" style="display:none;flex:1.5;">
                            <select id="weekNumber" onchange="updateCalendar()"></select>
                        </div>
                    </div>
                </div>

                <div class="section full-width">
                    <div class="section-title">âœ¦ æ¯”ä¾‹</div>
                    <div class="pill-group">
                                                <button class="pill-btn" data-ratio="16:9" data-orient="horizontal" onclick="changeRatio(this)">16:9</button>
                        <button class="pill-btn" data-ratio="4:3" data-orient="horizontal" onclick="changeRatio(this)">4:3</button>
                        <button class="pill-btn" data-ratio="3:2" data-orient="horizontal" onclick="changeRatio(this)">3:2</button>
                        <button class="pill-btn" data-ratio="1:1" data-orient="vertical" onclick="changeRatio(this)">1:1</button>
                        <button class="pill-btn active" data-ratio="3:4" data-orient="vertical" onclick="changeRatio(this)">3:4</button>
                        <button class="pill-btn" data-ratio="2:3" data-orient="vertical" onclick="changeRatio(this)">2:3</button>
                        <button class="pill-btn" data-ratio="1:2" data-orient="vertical" onclick="changeRatio(this)">1:2</button>
                        <button class="pill-btn" data-ratio="9:16" data-orient="vertical" onclick="changeRatio(this)">9:16</button>
                        <span class="custom-ratio-wrap" style="position:relative;">
                            <input type="number" id="customRatioW" min="1" max="20" value="1" style="width:48px;padding:5px;text-align:center;font-size:11px;" onfocus="showRatioSlider('w')" onblur="hideRatioSlider('w')" oninput="updateRatioFromInput()">
                            <span style="font-size:11px;">:</span>
                            <input type="number" id="customRatioH" min="1" max="20" value="1" style="width:48px;padding:5px;text-align:center;font-size:11px;" onfocus="showRatioSlider('h')" onblur="hideRatioSlider('h')" oninput="updateRatioFromInput()">
                            <button class="pill-btn" onclick="applyCustomRatio()" style="padding:5px 10px;white-space:nowrap;">åº”ç”¨</button>
                            <div class="ratio-slider" id="ratioWSliderWrap">
                                <span>å®½</span>
                                <input type="range" id="ratioWSlider" min="1" max="20" value="1" step="1" oninput="updateRatioFromSlider('w')">
                                <span id="ratioWValue">1</span>
                            </div>
                            <div class="ratio-slider" id="ratioHSliderWrap">
                                <span>é«˜</span>
                                <input type="range" id="ratioHSlider" min="1" max="20" value="1" step="1" oninput="updateRatioFromSlider('h')">
                                <span id="ratioHValue">1</span>
                            </div>
                        </span>
                    </div>
                </div>

                <div class="section">
                    <div class="section-title">âœ¦ å›¾ç‰‡ä½ç½®</div>
                    <div class="pill-group" id="positionGroup">
                        <button class="pill-btn" data-pos="left" onclick="changePosition(this)" disabled>å›¾å·¦</button>
                        <button class="pill-btn" data-pos="right" onclick="changePosition(this)" disabled>å›¾å³</button>
                        <button class="pill-btn" data-pos="top" onclick="changePosition(this)">å›¾ä¸Š</button>
                        <button class="pill-btn active" data-pos="bottom" onclick="changePosition(this)">å›¾ä¸‹</button>
                        <button class="pill-btn" data-pos="none" onclick="changePosition(this)">æ— å›¾</button>
                    </div>
                </div>

                <div class="section">
                    <div class="section-title">âœ¦ æ—¥å†æ ·å¼</div>
                    <div class="btn-grid cols-3">
                        <button class="grid-btn active" data-style="full" onclick="changeStyle(this)">å®Œæ•´</button>
                        <button class="grid-btn" data-style="solar" onclick="changeStyle(this)">å…¬å†</button>
                        <button class="grid-btn" data-style="note" onclick="changeStyle(this)">å¡«å†™</button>
                    </div>
                    <div style="display:flex;align-items:center;gap:8px;margin-top:8px;flex-wrap:wrap;">
                        <label style="display:flex;align-items:center;gap:5px;font-size:9px;color:var(--primary-light);cursor:pointer;">
                            <input type="checkbox" id="dividerToggle" onchange="toggleDivider()" style="accent-color:var(--primary);cursor:pointer;width:12px;height:12px;">
                            åˆ†éš”çº¿
                        </label>
                        <div id="dividerThicknessWrap" style="display:none;align-items:center;gap:4px;">
                            <input type="range" id="dividerThickness" min="1" max="4" value="1" step="0.5" style="width:50px;accent-color:var(--primary);" oninput="updateDividerThickness()">
                            <span id="dividerThicknessValue" style="font-size:9px;color:var(--primary-light);min-width:24px;">1px</span>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <div class="section-title">âœ¦ ä¸»é¢˜è‰²</div>
                    <div class="color-row">
                        <div class="color-btn" style="background:#4A4A4A" data-color="#4A4A4A" onclick="changeTheme(this)" title="æ·±ç°"></div>
                        <div class="color-btn active" style="background:#5D4E4A" data-color="#5D4E4A" onclick="changeTheme(this)" title="æš–æ£•"></div>
                        <div class="color-btn" style="background:#7D8B8A" data-color="#7D8B8A" onclick="changeTheme(this)" title="é’ç°"></div>
                        <div class="color-btn" style="background:#9B8AA5" data-color="#9B8AA5" onclick="changeTheme(this)" title="ç°ç´«"></div>
                        <div class="color-btn" style="background:#C4A99B" data-color="#C4A99B" onclick="changeTheme(this)" title="å¥¶èŒ¶"></div>
                        <div class="color-btn" style="background:#8FA587" data-color="#8FA587" onclick="changeTheme(this)" title="è‹”ç»¿"></div>
                        <div class="color-btn" style="background:#B8977E" data-color="#B8977E" onclick="changeTheme(this)" title="ç„¦ç³–"></div>
                        <div class="color-btn" style="background:#A5B5C5" data-color="#A5B5C5" onclick="changeTheme(this)" title="é›¾è“"></div>
                        <div class="color-picker-wrap">
                            <input type="color" id="customColor" value="#5D4E4A" oninput="changeCustomColor(this)" title="è‡ªå®šä¹‰">
                            <span class="color-picker-label">è‡ªå®šä¹‰</span>
                        </div>
                    </div>
                    <div class="saved-colors" id="savedColors"></div>
                    <div class="saved-colors-hint" id="savedColorsHint">é•¿æŒ‰æˆ–æ‹–å‡ºå¯åˆ é™¤</div>
                </div>

                <div class="section">
                    <div class="section-title">âœ¦ å­—ä½“</div>
                    <div class="form-row" style="align-items:center;margin-bottom:8px;">
                        <span style="font-size:10px;color:var(--primary-light);white-space:nowrap;">å¤§å°</span>
                        <input type="range" id="fontSizeSlider" min="50" max="200" value="120" style="flex:1;accent-color:var(--primary);" oninput="changeFontSize()">
                        <span id="fontSizeValue" style="font-size:10px;min-width:36px;text-align:right;">120%</span>
                    </div>
                    <div class="custom-select-wrap" id="fontSelectWrap">
                        <div class="custom-select-trigger" id="fontSelectTrigger" onclick="toggleFontDropdown()">
                            <span id="fontSelectText">é¸¿è’™é»‘ä½“</span>
                            <svg width="12" height="12" viewBox="0 0 12 12"><path fill="currentColor" d="M2 4l4 4 4-4"/></svg>
                        </div>
                        <div class="custom-select-dropdown" id="fontSelectDropdown">
                            <div class="custom-select-option" data-value="æ€æºé»‘ä½“">æ€æºé»‘ä½“</div>
                            <div class="custom-select-option" data-value="é¸¿è’™é»‘ä½“">é¸¿è’™é»‘ä½“</div>
                            <div class="custom-select-option" data-value="é˜¿é‡Œå¦ˆå¦ˆæ•°é»‘ä½“">é˜¿é‡Œå¦ˆå¦ˆæ•°é»‘ä½“</div>
                            <div class="custom-select-option" data-value="æ±ŸåŸé»‘ä½“">æ±ŸåŸé»‘ä½“ <span class="recommend-tag">æ¨è</span></div>
                            <div class="custom-select-option" data-value="å¾—æ„é»‘">å¾—æ„é»‘</div>
                            <div class="custom-select-option" data-value="é˜¿é‡Œå¦ˆå¦ˆæ–¹åœ†ä½“">é˜¿é‡Œå¦ˆå¦ˆæ–¹åœ†ä½“</div>
                            <div class="custom-select-option" data-value="å¯’è‰åŠåœ†ä½“">å¯’è‰åŠåœ†ä½“</div>
                            <div class="custom-select-option" data-value="ä¹ç±³æ³¢æ³¢ä½“">ä¹ç±³æ³¢æ³¢ä½“</div>
                            <div class="custom-select-option" data-value="è†å—åœ†ä½“">è†å—åœ†ä½“</div>
                            <div class="custom-select-option" data-value="æ€å°å®‹">æ€å°å®‹ <span class="recommend-tag">æ¨è</span></div>
                            <div class="custom-select-option" data-value="é¦™èƒç­‰ç²—å®‹">é¦™èƒç­‰ç²—å®‹</div>
                            <div class="custom-select-option" data-value="èŠ±ä»¿å®‹">èŠ±ä»¿å®‹</div>
                            <div class="custom-select-option" data-value="æœ±é›€ä»¿å®‹">æœ±é›€ä»¿å®‹</div>
                            <div class="custom-select-option" data-value="ç«™é…·ä»“è€³æ¸”é˜³ä½“">ç«™é…·ä»“è€³æ¸”é˜³ä½“</div>
                            <div class="custom-select-option" data-value="éœé¹œæ–‡æ¥·">éœé¹œæ–‡æ¥· <span class="recommend-tag">æ¨è</span></div>
                            <div class="custom-select-option" data-value="å¤©ç‹æ˜Ÿåƒç´ ">å¤©ç‹æ˜Ÿåƒç´  <span class="recommend-tag">æ¨è</span></div>
                        </div>
                        <select id="calendarFont" style="display:none;" onchange="changeFont()">
                            <option value="æ€æºé»‘ä½“">æ€æºé»‘ä½“</option>
                            <option value="é¸¿è’™é»‘ä½“">é¸¿è’™é»‘ä½“</option>
                            <option value="é˜¿é‡Œå¦ˆå¦ˆæ•°é»‘ä½“">é˜¿é‡Œå¦ˆå¦ˆæ•°é»‘ä½“</option>
                            <option value="æ±ŸåŸé»‘ä½“">æ±ŸåŸé»‘ä½“</option>
                            <option value="å¾—æ„é»‘">å¾—æ„é»‘</option>
                            <option value="é˜¿é‡Œå¦ˆå¦ˆæ–¹åœ†ä½“">é˜¿é‡Œå¦ˆå¦ˆæ–¹åœ†ä½“</option>
                            <option value="å¯’è‰åŠåœ†ä½“">å¯’è‰åŠåœ†ä½“</option>
                            <option value="ä¹ç±³æ³¢æ³¢ä½“">ä¹ç±³æ³¢æ³¢ä½“</option>
                            <option value="è†å—åœ†ä½“">è†å—åœ†ä½“</option>
                            <option value="æ€å°å®‹">æ€å°å®‹</option>
                            <option value="é¦™èƒç­‰ç²—å®‹">é¦™èƒç­‰ç²—å®‹</option>
                            <option value="èŠ±ä»¿å®‹">èŠ±ä»¿å®‹</option>
                            <option value="æœ±é›€ä»¿å®‹">æœ±é›€ä»¿å®‹</option>
                            <option value="ç«™é…·ä»“è€³æ¸”é˜³ä½“">ç«™é…·ä»“è€³æ¸”é˜³ä½“</option>
                            <option value="éœé¹œæ–‡æ¥·">éœé¹œæ–‡æ¥·</option>
                            <option value="å¤©ç‹æ˜Ÿåƒç´ ">å¤©ç‹æ˜Ÿåƒç´ </option>
                        </select>
                    </div>
                </div>

                <div class="section">
                    <div class="section-title">âœ¦ åº•éƒ¨æ–‡å­—</div>
                    <input type="text" id="footerText" value="æ—¥å†å°åŠ©æ‰‹" oninput="updateFooter()">
                </div>

                <div class="section">
                    <div class="section-title">âœ¦ èƒŒæ™¯å›¾</div>
                    <div class="upload-box" id="bgUpload">
                        <input type="file" id="bgInput" accept="image/*">
                        <div class="icon">ğŸ¨</div>
                        <div class="text">ä¸Šä¼ èƒŒæ™¯</div>
                        <div class="sub" style="font-size:9px;color:var(--primary-light);opacity:0.7;margin-top:2px;">Alt+æ‹–æ‹½ç§»åŠ¨ Â· Alt+æ»šè½®ç¼©æ”¾</div>
                    </div>
                    <div class="bg-opacity-row" id="bgOpacityRow" style="display:none;">
                        <span style="font-size:10px;color:var(--primary-light);">é€æ˜åº¦</span>
                        <input type="range" id="bgOpacitySlider" min="10" max="100" value="30" style="flex:1;accent-color:var(--primary);" oninput="changeBgOpacity()">
                        <span id="bgOpacityValue" style="font-size:10px;min-width:32px;text-align:right;">30%</span>
                    </div>
                </div>

                <div class="section full-width settings-save-section">
                    <div class="section-title">âœ¦ è®¾ç½®æ¨¡æ¿</div>
                    <div class="settings-row">
                        <div class="custom-select-wrap settings-select-wrap" id="settingsSelectWrap">
                            <div class="custom-select-trigger" id="settingsSelectTrigger" onclick="toggleSettingsDropdown()">
                                <span id="settingsSelectText">é€‰æ‹©å·²ä¿å­˜çš„è®¾ç½®...</span>
                                <svg width="12" height="12" viewBox="0 0 12 12"><path fill="currentColor" d="M2 4l4 4 4-4"/></svg>
                            </div>
                            <div class="custom-select-dropdown" id="settingsSelectDropdown">
                                <div class="custom-select-option settings-placeholder" data-value="">é€‰æ‹©å·²ä¿å­˜çš„è®¾ç½®...</div>
                            </div>
                            <select id="savedSettingsSelect" style="display:none;" onchange="loadSavedSettings()">
                                <option value="">é€‰æ‹©å·²ä¿å­˜çš„è®¾ç½®...</option>
                            </select>
                        </div>
                        <button class="settings-btn save" onclick="showSaveSettingsDialog()" title="åœ¨è¿™é‡Œä¿å­˜è®¾ç½®å“¦~">ğŸ’¾</button>
                        <button class="settings-btn delete" onclick="deleteSavedSettings()" title="åˆ é™¤é€‰ä¸­çš„è®¾ç½®">ğŸ—‘ï¸</button>
                    </div>
                    <div class="settings-tip">ğŸ’¡ ä¿å­˜è®¾ç½®åï¼Œ12å¼ æœˆå†/å‘¨å†ç”¨åŒä¸€ä¸ªæ¨¡æ¿ï¼Œå°ºå¯¸é£æ ¼éƒ½ä¸€è‡´å“¦~</div>
                </div>
            </div>

        </div>
    </div>

    <script>
        let currentOrientation = 'vertical';
        let currentPosition = 'bottom';
        let currentStyle = 'full';
        let cardWidth = 390, cardHeight = 520;
        let sizeUnit = 'px';
        let previewZoom = 100;
        let fontSizeMultiplier = 1.2;
        const PX_PER_CM = 37.8; // 96 DPI

        let currentImageSrc = null, currentBgSrc = null;
        let imgScale = 1, imgOffsetX = 0, imgOffsetY = 0, imgBaseScale = 1;
        let bgScale = 1, bgOffsetX = 0, bgOffsetY = 0;
        let isDragging = false, dragStartX, dragStartY, startOffsetX, startOffsetY;
        let isBgDragging = false, bgDragStartX, bgDragStartY, bgStartOffsetX, bgStartOffsetY;
        let isResizing = false, resizeDir = '', resizeStartX, resizeStartY, startWidth, startHeight;

        document.addEventListener('DOMContentLoaded', function() {
            const monthSelect = document.getElementById('month');
            for (let i = 1; i <= 12; i++) {
                const opt = document.createElement('option');
                opt.value = i;
                opt.textContent = i + 'æœˆ';
                monthSelect.appendChild(opt);
            }
            const now = new Date();
            document.getElementById('year').value = now.getFullYear();
            document.getElementById('month').value = now.getMonth() + 1;

            setupBgUpload();
            initImageSection();
            initBgLayer();
            initResizeHandles();
            applyCardSize();
            updateCalendar();
            renderSizeHistory();
            renderSavedColors();
            renderSavedSettingsSelect();
            updatePresetOptions();
            setTimeout(autoFitPreview, 100);

            // è½®æ’­æç¤º
            initTipsRotation();

            // ç§»åŠ¨ç«¯æ›´æ–°å ä½ç¬¦æç¤º
            if ('ontouchstart' in window) {
                const placeholderSub = document.querySelector('#imageSection .placeholder .sub');
                if (placeholderSub) placeholderSub.textContent = 'æ‹–åŠ¨ç§»åŠ¨ Â· åŒæŒ‡ç¼©æ”¾';
            }

            // Ctrl + æ»šè½®ç¼©æ”¾æ—¥å†æ˜¾ç¤º
            document.querySelector('.preview-area').addEventListener('wheel', (e) => {
                if (e.ctrlKey) {
                    e.preventDefault();
                    const delta = e.deltaY > 0 ? -5 : 5;
                    previewZoom = Math.max(10, Math.min(200, previewZoom + delta));
                    document.getElementById('previewZoom').value = previewZoom;
                    document.getElementById('zoomValue').textContent = previewZoom + '%';
                    applyCardSize();
                }
            }, { passive: false });

            // è‡ªå®šä¹‰å­—ä½“ä¸‹æ‹‰æ¡†åˆå§‹åŒ–
            initFontDropdown();
            initSettingsDropdown();
        });

        // è‡ªå®šä¹‰å­—ä½“ä¸‹æ‹‰æ¡†
        function initFontDropdown() {
            const dropdown = document.getElementById('fontSelectDropdown');
            const options = dropdown.querySelectorAll('.custom-select-option');
            const hiddenSelect = document.getElementById('calendarFont');

            // åˆå§‹åŒ–é€‰ä¸­çŠ¶æ€
            updateFontDropdownSelection(hiddenSelect.value);

            // ç‚¹å‡»é€‰é¡¹
            options.forEach(opt => {
                opt.addEventListener('click', () => {
                    const value = opt.getAttribute('data-value');
                    hiddenSelect.value = value;
                    document.getElementById('fontSelectText').textContent = value;
                    updateFontDropdownSelection(value);
                    closeFontDropdown();
                    changeFont();
                });
            });

            // ç‚¹å‡»å¤–éƒ¨å…³é—­
            document.addEventListener('click', (e) => {
                const wrap = document.getElementById('fontSelectWrap');
                if (!wrap.contains(e.target)) {
                    closeFontDropdown();
                }
            });
        }

        function toggleFontDropdown() {
            const trigger = document.getElementById('fontSelectTrigger');
            const dropdown = document.getElementById('fontSelectDropdown');
            trigger.classList.toggle('active');
            dropdown.classList.toggle('show');
        }

        function closeFontDropdown() {
            document.getElementById('fontSelectTrigger').classList.remove('active');
            document.getElementById('fontSelectDropdown').classList.remove('show');
        }

        function updateFontDropdownSelection(value) {
            const options = document.querySelectorAll('#fontSelectDropdown .custom-select-option');
            options.forEach(opt => {
                if (opt.getAttribute('data-value') === value) {
                    opt.classList.add('selected');
                } else {
                    opt.classList.remove('selected');
                }
            });
            document.getElementById('fontSelectText').textContent = value;
        }

        // è‡ªå®šä¹‰è®¾ç½®æ¨¡æ¿ä¸‹æ‹‰æ¡†
        function initSettingsDropdown() {
            // ç‚¹å‡»å¤–éƒ¨å…³é—­
            document.addEventListener('click', (e) => {
                const wrap = document.getElementById('settingsSelectWrap');
                if (wrap && !wrap.contains(e.target)) {
                    closeSettingsDropdown();
                }
            });
        }

        function toggleSettingsDropdown() {
            const trigger = document.getElementById('settingsSelectTrigger');
            const dropdown = document.getElementById('settingsSelectDropdown');
            trigger.classList.toggle('active');
            dropdown.classList.toggle('show');
        }

        function closeSettingsDropdown() {
            const trigger = document.getElementById('settingsSelectTrigger');
            const dropdown = document.getElementById('settingsSelectDropdown');
            if (trigger) trigger.classList.remove('active');
            if (dropdown) dropdown.classList.remove('show');
        }

        function selectSettingsOption(index, name) {
            const hiddenSelect = document.getElementById('savedSettingsSelect');
            hiddenSelect.value = index;
            document.getElementById('settingsSelectText').textContent = name || 'é€‰æ‹©å·²ä¿å­˜çš„è®¾ç½®...';
            closeSettingsDropdown();
            if (index !== '') {
                loadSavedSettings();
            }
        }

        const isMobile = 'ontouchstart' in window;
        const tips = isMobile ? [
            'å†…å®¹è¶…å‡ºåˆ«æ‹…å¿ƒï¼Œè°ƒæ•´å­—ä½“å¤§å°å³å¯',
            'å›¾ç‰‡æ”¯æŒæ‹–åŠ¨ç§»åŠ¨å’ŒåŒæŒ‡ç¼©æ”¾',
            'è®°å¾—ä¿å­˜è®¾ç½®ï¼Œ12å¼ æ—¥å†é£æ ¼ç»Ÿä¸€',
            'é¡¶éƒ¨å¯åˆ‡æ¢æœˆå†/å‘¨å†å“¦'
        ] : [
            'å†…å®¹è¶…å‡ºåˆ«æ‹…å¿ƒï¼Œè°ƒæ•´å­—ä½“å¤§å°å³å¯',
            'Ctrl+æ»šè½®å¯å¿«é€Ÿç¼©æ”¾é¢„è§ˆå¤§å°',
            'è®°å¾—ä¿å­˜è®¾ç½®ï¼Œ12å¼ æ—¥å†é£æ ¼ç»Ÿä¸€',
            'é¡¶éƒ¨å¯åˆ‡æ¢æœˆå†/å‘¨å†å“¦'
        ];
        let currentTipIndex = 0;

        function initTipsRotation() {
            setInterval(() => {
                const container = document.getElementById('tipsContainer');
                const tipText = document.getElementById('tipText');

                // æ·¡å‡º
                container.classList.add('fade-out');

                setTimeout(() => {
                    // åˆ‡æ¢æ–‡å­—
                    currentTipIndex = (currentTipIndex + 1) % tips.length;
                    tipText.textContent = tips[currentTipIndex];

                    // æ·¡å…¥
                    container.classList.remove('fade-out');
                }, 500);
            }, 5000);
        }

        function setupBgUpload() {
            const area = document.getElementById('bgUpload');
            const input = document.getElementById('bgInput');
            area.onclick = (e) => { if (e.target.tagName !== 'BUTTON') input.click(); };
            input.onchange = function() { if (this.files && this.files[0]) processFile(this.files[0], 'bg'); };

            // æ‹–æ‹½ä¸Šä¼ 
            area.ondragover = (e) => {
                e.preventDefault();
                area.style.borderColor = 'var(--primary)';
                area.style.background = 'var(--yellow)';
            };
            area.ondragleave = () => {
                area.style.borderColor = '';
                area.style.background = '';
            };
            area.ondrop = (e) => {
                e.preventDefault();
                area.style.borderColor = '';
                area.style.background = '';
                if (e.dataTransfer.files.length && e.dataTransfer.files[0].type.startsWith('image/')) {
                    processFile(e.dataTransfer.files[0], 'bg');
                }
            };
        }

        function initImageSection() {
            const section = document.getElementById('imageSection');

            section.onclick = function(e) {
                if (!currentImageSrc && e.target.closest('.placeholder')) {
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = 'image/*';
                    input.onchange = function() { if (this.files && this.files[0]) processFile(this.files[0], 'image'); };
                    input.click();
                }
            };

            section.ondragover = (e) => { e.preventDefault(); section.classList.add('drag-over'); };
            section.ondragleave = () => section.classList.remove('drag-over');
            section.ondrop = (e) => {
                e.preventDefault();
                section.classList.remove('drag-over');
                if (e.dataTransfer.files.length && e.dataTransfer.files[0].type.startsWith('image/')) {
                    processFile(e.dataTransfer.files[0], 'image');
                }
            };

            section.onmousedown = (e) => {
                if (currentImageSrc && e.button === 0) {
                    isDragging = true;
                    dragStartX = e.clientX;
                    dragStartY = e.clientY;
                    startOffsetX = imgOffsetX;
                    startOffsetY = imgOffsetY;
                    section.classList.add('dragging');
                    e.preventDefault();
                }
            };

            document.addEventListener('mousemove', handleMouseMove);
            document.addEventListener('mouseup', handleMouseUp);

            // è§¦æ‘¸äº‹ä»¶æ”¯æŒï¼ˆç§»åŠ¨ç«¯ï¼‰
            section.ontouchstart = (e) => {
                if (currentImageSrc && e.touches.length === 1) {
                    isDragging = true;
                    dragStartX = e.touches[0].clientX;
                    dragStartY = e.touches[0].clientY;
                    startOffsetX = imgOffsetX;
                    startOffsetY = imgOffsetY;
                    section.classList.add('dragging');
                }
            };
            document.addEventListener('touchmove', (e) => {
                if (isDragging && e.touches.length === 1) {
                    const dx = e.touches[0].clientX - dragStartX;
                    const dy = e.touches[0].clientY - dragStartY;
                    imgOffsetX = startOffsetX + dx;
                    imgOffsetY = startOffsetY + dy;
                    updateImageTransform();
                }
            }, { passive: true });
            document.addEventListener('touchend', () => {
                if (isDragging) {
                    isDragging = false;
                    section.classList.remove('dragging');
                }
            });

            // åŒæŒ‡ç¼©æ”¾ï¼ˆç§»åŠ¨ç«¯ï¼‰
            let lastTouchDist = 0;
            section.addEventListener('touchstart', (e) => {
                if (currentImageSrc && e.touches.length === 2) {
                    const dx = e.touches[0].clientX - e.touches[1].clientX;
                    const dy = e.touches[0].clientY - e.touches[1].clientY;
                    lastTouchDist = Math.sqrt(dx * dx + dy * dy);
                }
            });
            section.addEventListener('touchmove', (e) => {
                if (currentImageSrc && e.touches.length === 2) {
                    e.preventDefault();
                    const dx = e.touches[0].clientX - e.touches[1].clientX;
                    const dy = e.touches[0].clientY - e.touches[1].clientY;
                    const dist = Math.sqrt(dx * dx + dy * dy);
                    if (lastTouchDist > 0) {
                        const delta = (dist - lastTouchDist) * 0.01;
                        const minScale = imgBaseScale * 0.5;
                        const maxScale = imgBaseScale * 5;
                        imgScale = Math.max(minScale, Math.min(maxScale, imgScale + delta));
                        updateImageTransform();
                    }
                    lastTouchDist = dist;
                }
            }, { passive: false });

            section.onwheel = (e) => {
                if (currentImageSrc) {
                    e.preventDefault();
                    const delta = e.deltaY > 0 ? -0.1 : 0.1;
                    // æœ€å°ç¼©æ”¾ä¸ºåŸºç¡€ç¼©æ”¾çš„50%ï¼Œæœ€å¤§ä¸ºåŸºç¡€ç¼©æ”¾çš„5å€
                    const minScale = imgBaseScale * 0.5;
                    const maxScale = imgBaseScale * 5;
                    imgScale = Math.max(minScale, Math.min(maxScale, imgScale + delta));
                    updateImageTransform();
                }
            };
        }

        function handleMouseMove(e) {
            if (isDragging) {
                const dx = e.clientX - dragStartX;
                const dy = e.clientY - dragStartY;
                imgOffsetX = startOffsetX + dx;
                imgOffsetY = startOffsetY + dy;
                updateImageTransform();
            }
            if (isBgDragging) {
                const dx = e.clientX - bgDragStartX;
                const dy = e.clientY - bgDragStartY;
                bgOffsetX = bgStartOffsetX + dx;
                bgOffsetY = bgStartOffsetY + dy;
                updateBgTransform();
            }
            if (isResizing) {
                handleResize(e);
            }
        }

        function handleMouseUp() {
            if (isDragging) {
                isDragging = false;
                document.getElementById('imageSection').classList.remove('dragging');
            }
            if (isBgDragging) {
                isBgDragging = false;
            }
            if (isResizing) {
                isResizing = false;
                document.getElementById('resizeTooltip').classList.remove('show');
                // æ‹–æ‹½ç»“æŸåè‡ªåŠ¨ä¿å­˜å°ºå¯¸
                autoSaveSize();
            }
        }

        function initResizeHandles() {
            document.querySelectorAll('.resize-handle').forEach(handle => {
                handle.onmousedown = (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    isResizing = true;
                    resizeDir = handle.dataset.dir;
                    resizeStartX = e.clientX;
                    resizeStartY = e.clientY;
                    startWidth = cardWidth;
                    startHeight = cardHeight;
                };
            });
        }

        function handleResize(e) {
            const dx = e.clientX - resizeStartX;
            const dy = e.clientY - resizeStartY;

            if (resizeDir.includes('e')) cardWidth = Math.max(300, startWidth + dx);
            if (resizeDir.includes('s')) cardHeight = Math.max(200, startHeight + dy);

            applyCardSize();
            syncSizeInputs();
            updateSliders();

            // æ˜¾ç¤ºå°ºå¯¸æç¤º
            const tooltip = document.getElementById('resizeTooltip');
            let text = `${Math.round(cardWidth)} Ã— ${Math.round(cardHeight)} px`;
            if (sizeUnit === 'cm') {
                text += ` (${(cardWidth / PX_PER_CM).toFixed(1)} Ã— ${(cardHeight / PX_PER_CM).toFixed(1)} cm)`;
            }
            tooltip.textContent = text;
            tooltip.classList.add('show');
            tooltip.style.left = (e.clientX + 15) + 'px';
            tooltip.style.top = (e.clientY + 15) + 'px';
        }

        function applyCardSize() {
            const card = document.getElementById('calendarCard');
            const container = document.getElementById('canvasContainer');
            const calSection = document.getElementById('calendarSection');
            card.style.width = cardWidth + 'px';
            card.style.height = cardHeight + 'px';
            container.style.transform = `scale(${previewZoom / 100})`;
            container.style.transformOrigin = 'center center';

            // æ ¹æ®æ—¥å†åŒºåŸŸå¤§å°è®¡ç®—å­—ä½“ç¼©æ”¾æ¯”ä¾‹
            // åŸºå‡†ï¼š400pxå®½åº¦æ—¶ç¼©æ”¾ä¸º1
            const calWidth = cardWidth * 0.65; // æ—¥å†åŒºåŸŸçº¦å 65%
            const calHeight = cardHeight;
            const baseSize = 350;
            const autoScale = Math.min(calWidth, calHeight) / baseSize;
            const finalScale = Math.max(0.6, Math.min(4, autoScale * fontSizeMultiplier));
            calSection.style.setProperty('--cal-scale', finalScale.toFixed(2));
        }

        function syncSizeInputs() {
            if (sizeUnit === 'px') {
                document.getElementById('widthInput').value = Math.round(cardWidth);
                document.getElementById('heightInput').value = Math.round(cardHeight);
            } else {
                document.getElementById('widthInput').value = (cardWidth / PX_PER_CM).toFixed(1);
                document.getElementById('heightInput').value = (cardHeight / PX_PER_CM).toFixed(1);
            }
        }

        function updateSizeFromInput() {
            let w = parseFloat(document.getElementById('widthInput').value) || 400;
            let h = parseFloat(document.getElementById('heightInput').value) || 300;
            if (sizeUnit === 'cm') {
                // A3 é™åˆ¶: æœ€å¤§ 42cm
                w = Math.min(42, Math.max(5, w));
                h = Math.min(42, Math.max(5, h));
                cardWidth = Math.round(w * PX_PER_CM);
                cardHeight = Math.round(h * PX_PER_CM);
            } else {
                cardWidth = Math.min(3000, Math.max(100, Math.round(w)));
                cardHeight = Math.min(3000, Math.max(100, Math.round(h)));
            }
            applyCardSize();
            autoFitPreview();
        }

        function autoFitPreview() {
            const previewArea = document.querySelector('.preview-area');
            const sizeControls = document.querySelector('.size-controls');
            const zoomControls = document.querySelector('.zoom-controls');
            const sizeHistory = document.getElementById('sizeHistory');

            // è®¡ç®—å¯ç”¨åŒºåŸŸï¼Œæ’é™¤æ§åˆ¶æ å ç”¨çš„ç©ºé—´
            const sizeControlsHeight = sizeControls ? sizeControls.offsetHeight : 0;
            const sizeHistoryHeight = sizeHistory && sizeHistory.children.length > 0 ? sizeHistory.offsetHeight + 12 : 0;
            const topMargin = sizeControlsHeight + sizeHistoryHeight + 30; // é¡¶éƒ¨æ§åˆ¶æ +å†å²è®°å½•+é—´è·
            const bottomMargin = zoomControls ? zoomControls.offsetHeight + 20 : 40; // åº•éƒ¨æ§åˆ¶æ +é—´è·
            const sideMargin = 40; // å·¦å³è¾¹è·

            const availableWidth = previewArea.clientWidth - sideMargin * 2;
            const availableHeight = previewArea.clientHeight - topMargin - bottomMargin;

            const scaleW = availableWidth / cardWidth;
            const scaleH = availableHeight / cardHeight;
            const fitScale = Math.min(scaleW, scaleH) * 100;

            previewZoom = Math.max(10, Math.min(200, Math.round(fitScale)));
            document.getElementById('previewZoom').value = previewZoom;
            document.getElementById('zoomValue').textContent = previewZoom + '%';
            applyCardSize();
        }

        function changeSizeUnit() {
            sizeUnit = document.getElementById('sizeUnit').value;
            syncSizeInputs();
            updateSizeLimits();
            updatePresetOptions();
        }

        const presetsCm = [
            { label: 'A3 ç«–ç‰ˆ', w: 29.7, h: 42 },
            { label: 'A3 æ¨ªç‰ˆ', w: 42, h: 29.7 },
            { label: 'A4 ç«–ç‰ˆ', w: 21, h: 29.7 },
            { label: 'A4 æ¨ªç‰ˆ', w: 29.7, h: 21 },
            { label: 'A5 ç«–ç‰ˆ', w: 14.8, h: 21 },
            { label: 'A5 æ¨ªç‰ˆ', w: 21, h: 14.8 },
            { label: 'A6 ç«–ç‰ˆ', w: 10.5, h: 14.8 },
            { label: 'A6 æ¨ªç‰ˆ', w: 14.8, h: 10.5 },
        ];

        const presetsPx = [
            { label: 'iPhone å£çº¸', w: 1170, h: 2532 },
            { label: 'iPhone Pro Max', w: 1290, h: 2796 },
            { label: 'å®‰å“ 1080P', w: 1080, h: 1920 },
            { label: 'å®‰å“ 2K é•¿å±', w: 1080, h: 2340 },
            { label: 'å®‰å“ 2K é«˜æ¸…', w: 1440, h: 3200 },
            { label: 'iPad å£çº¸', w: 2048, h: 2732 },
            { label: 'å¾®ä¿¡æœ‹å‹åœˆ', w: 1080, h: 1080 },
            { label: 'å°çº¢ä¹¦å°é¢', w: 1242, h: 1660 },
        ];

        function updatePresetOptions() {
            const select = document.getElementById('sizePreset');
            const presets = sizeUnit === 'cm' ? presetsCm : presetsPx;
            select.innerHTML = '<option value="">é¢„è®¾å°ºå¯¸</option>' +
                presets.map((p, i) => `<option value="${i}">${p.label} (${p.w}Ã—${p.h})</option>`).join('');
        }

        function applyPreset() {
            const select = document.getElementById('sizePreset');
            const index = select.value;
            if (index === '') return;

            const presets = sizeUnit === 'cm' ? presetsCm : presetsPx;
            const p = presets[parseInt(index)];

            if (sizeUnit === 'cm') {
                cardWidth = Math.round(p.w * PX_PER_CM);
                cardHeight = Math.round(p.h * PX_PER_CM);
            } else {
                cardWidth = p.w;
                cardHeight = p.h;
            }

            // æ›´æ–°æ–¹å‘
            const orient = cardWidth >= cardHeight ? 'horizontal' : 'vertical';
            currentOrientation = orient;
            const card = document.getElementById('calendarCard');
            card.classList.remove('horizontal', 'vertical');
            card.classList.add(orient);
            updatePositionButtons();

            syncSizeInputs();
            applyCardSize();
            autoFitPreview();
            select.value = ''; // é‡ç½®é€‰æ‹©
        }

        function updateSizeLimits() {
            const widthInput = document.getElementById('widthInput');
            const heightInput = document.getElementById('heightInput');
            if (sizeUnit === 'cm') {
                // A3 æœ€å¤§å°ºå¯¸: 29.7cm x 42cm
                widthInput.max = 42;
                heightInput.max = 42;
                widthInput.min = 5;
                heightInput.min = 5;
                widthInput.step = 0.5;
                heightInput.step = 0.5;
            } else {
                widthInput.max = 3000;
                heightInput.max = 3000;
                widthInput.min = 100;
                heightInput.min = 100;
                widthInput.step = 10;
                heightInput.step = 10;
            }
        }

        let sliderTimeout;
        function showSlider(type) {
            clearTimeout(sliderTimeout);
            document.getElementById('widthSliderWrap').classList.remove('show');
            document.getElementById('heightSliderWrap').classList.remove('show');
            document.getElementById(type + 'SliderWrap').classList.add('show');
            updateSliders();
        }
        function hideSlider(type) {
            sliderTimeout = setTimeout(() => {
                document.getElementById(type + 'SliderWrap').classList.remove('show');
            }, 200);
        }

        let ratioSliderTimeout;
        function showRatioSlider(type) {
            clearTimeout(ratioSliderTimeout);
            document.getElementById('ratioWSliderWrap').classList.remove('show');
            document.getElementById('ratioHSliderWrap').classList.remove('show');
            const slider = document.getElementById('ratio' + type.toUpperCase() + 'SliderWrap');
            slider.classList.add('show');
            // åŒæ­¥æ»‘å—å€¼
            const inputVal = parseInt(document.getElementById('customRatio' + type.toUpperCase()).value) || 1;
            document.getElementById('ratio' + type.toUpperCase() + 'Slider').value = inputVal;
            document.getElementById('ratio' + type.toUpperCase() + 'Value').textContent = inputVal;
        }
        function hideRatioSlider(type) {
            ratioSliderTimeout = setTimeout(() => {
                document.getElementById('ratio' + type.toUpperCase() + 'SliderWrap').classList.remove('show');
            }, 200);
        }
        function updateRatioFromSlider(type) {
            const val = parseInt(document.getElementById('ratio' + type.toUpperCase() + 'Slider').value);
            document.getElementById('customRatio' + type.toUpperCase()).value = val;
            document.getElementById('ratio' + type.toUpperCase() + 'Value').textContent = val;
        }
        function updateRatioFromInput() {
            const wVal = parseInt(document.getElementById('customRatioW').value) || 1;
            const hVal = parseInt(document.getElementById('customRatioH').value) || 1;
            document.getElementById('ratioWSlider').value = wVal;
            document.getElementById('ratioHSlider').value = hVal;
            document.getElementById('ratioWValue').textContent = wVal;
            document.getElementById('ratioHValue').textContent = hVal;
        }

        function updatePreviewZoom() {
            previewZoom = parseInt(document.getElementById('previewZoom').value);
            document.getElementById('zoomValue').textContent = previewZoom + '%';
            applyCardSize();
        }

        let sizeHistory = JSON.parse(localStorage.getItem('calendarSizeHistory') || '[]');
        // é™åˆ¶æœ€å¤š3ä¸ª
        if (sizeHistory.length > 3) {
            sizeHistory = sizeHistory.slice(0, 3);
            localStorage.setItem('calendarSizeHistory', JSON.stringify(sizeHistory));
        }

        function autoSaveSize() {
            const sizeStr = sizeUnit === 'cm'
                ? `${(cardWidth / PX_PER_CM).toFixed(1)}Ã—${(cardHeight / PX_PER_CM).toFixed(1)}cm`
                : `${Math.round(cardWidth)}Ã—${Math.round(cardHeight)}px`;
            const sizeData = { w: cardWidth, h: cardHeight, unit: sizeUnit, label: sizeStr };

            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒå°ºå¯¸
            const exists = sizeHistory.some(s => s.w === cardWidth && s.h === cardHeight);
            if (!exists) {
                sizeHistory.unshift(sizeData);
                if (sizeHistory.length > 3) sizeHistory.pop(); // æœ€å¤šä¿å­˜3ä¸ª
                localStorage.setItem('calendarSizeHistory', JSON.stringify(sizeHistory));
                renderSizeHistory();
            }
        }

        function saveCurrentSize() {
            autoSaveSize();
        }

        function renderSizeHistory() {
            const container = document.getElementById('sizeHistory');
            container.innerHTML = sizeHistory.map((s, i) =>
                `<div class="size-chip" onclick="applySavedSize(${i})" title="ç‚¹å‡»åº”ç”¨æ­¤å°ºå¯¸">
                    ${s.label}
                    <span class="delete" onclick="event.stopPropagation();deleteSavedSize(${i})">âœ•</span>
                </div>`
            ).join('');
        }

        function applySavedSize(index) {
            const s = sizeHistory[index];
            cardWidth = s.w;
            cardHeight = s.h;
            syncSizeInputs();
            applyCardSize();
            autoFitPreview();
        }

        function deleteSavedSize(index) {
            sizeHistory.splice(index, 1);
            localStorage.setItem('calendarSizeHistory', JSON.stringify(sizeHistory));
            renderSizeHistory();
        }

        function resetToDefault() {
            // é»˜è®¤: 3:4 ç«–ç‰ˆï¼Œå›¾ç‰‡åœ¨ä¸‹æ–¹
            cardWidth = 390;
            cardHeight = 520;
            currentOrientation = 'vertical';
            currentPosition = 'bottom';

            const card = document.getElementById('calendarCard');
            card.classList.remove('horizontal', 'vertical');
            card.classList.add('vertical');
            card.dataset.pos = 'bottom';

            // é‡ç½®æ¯”ä¾‹æŒ‰é’®
            document.querySelectorAll('.pill-btn[data-ratio]').forEach(e => e.classList.remove('active'));
            document.querySelector('.pill-btn[data-ratio="3:4"]').classList.add('active');

            // é‡ç½®ä½ç½®æŒ‰é’®
            updatePositionButtons();
            document.querySelectorAll('#positionGroup .pill-btn').forEach(e => e.classList.remove('active'));
            document.querySelector('#positionGroup .pill-btn[data-pos="bottom"]').classList.add('active');

            syncSizeInputs();
            applyCardSize();
            autoFitPreview();
        }

        function processFile(file, type) {
            if (!file.type.startsWith('image/')) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                if (type === 'image') {
                    currentImageSrc = e.target.result;
                    imgOffsetX = 0;
                    imgOffsetY = 0;
                    // è·å–åŸå§‹å›¾ç‰‡å°ºå¯¸å¹¶è®¡ç®—é€‚é…å®½åº¦çš„ç¼©æ”¾
                    const img = new Image();
                    img.onload = function() {
                        originalImageSize = { width: img.width, height: img.height };
                        // è®¡ç®—è®©å›¾ç‰‡å®½åº¦é€‚é…å®¹å™¨å®½åº¦çš„ç¼©æ”¾æ¯”ä¾‹
                        const section = document.getElementById('imageSection');
                        if (section && img.width > 0) {
                            const sectionWidth = section.offsetWidth;
                            const sectionHeight = section.offsetHeight;
                            // è®¡ç®—è®©å›¾ç‰‡è¦†ç›–æ•´ä¸ªåŒºåŸŸéœ€è¦çš„æœ€å°ç¼©æ”¾
                            const scaleToFitWidth = sectionWidth / img.width;
                            const scaleToFitHeight = sectionHeight / img.height;
                            // ä½¿ç”¨è¾ƒå¤§å€¼ç¡®ä¿å›¾ç‰‡è¦†ç›–æ•´ä¸ªåŒºåŸŸ
                            imgBaseScale = Math.max(scaleToFitWidth, scaleToFitHeight);
                            imgScale = imgBaseScale;
                        } else {
                            imgBaseScale = 1;
                            imgScale = 1;
                        }
                        updateImageTransform();
                    };
                    img.src = e.target.result;
                    updateImageSection();
                } else {
                    currentBgSrc = e.target.result;
                    bgScale = 1;
                    bgOffsetX = 0;
                    bgOffsetY = 0;
                    updateBgLayer();
                    updateBgUploadArea();
                }
            };
            reader.readAsDataURL(file);
        }

        function updateImageSection() {
            const section = document.getElementById('imageSection');
            if (currentImageSrc) {
                const isTouchDevice = 'ontouchstart' in window;
                const hintText = isTouchDevice ? 'æ‹–åŠ¨ç§»åŠ¨ Â· åŒæŒ‡ç¼©æ”¾ Â· åŒå‡»åˆ é™¤' : 'æ‹–æ‹½ç§»åŠ¨ Â· æ»šè½®ç¼©æ”¾ Â· åŒå‡»åˆ é™¤';
                section.innerHTML = `<img src="${currentImageSrc}"><div class="image-hint">${hintText}</div>`;
                // å»¶è¿Ÿæ›´æ–°transformï¼Œç¡®ä¿DOMå·²æ¸²æŸ“
                setTimeout(() => updateImageTransform(), 0);
                section.ondblclick = () => {
                    currentImageSrc = null;
                    imgScale = 1;
                    imgOffsetX = 0;
                    imgOffsetY = 0;
                    originalImageSize = { width: 0, height: 0 };
                    updateImageSection();
                };
            } else {
                const isTouchPlaceholder = 'ontouchstart' in window;
                const subText = isTouchPlaceholder ? 'æ‹–åŠ¨ç§»åŠ¨ Â· åŒæŒ‡ç¼©æ”¾' : 'æ‹–æ‹½ç§»åŠ¨ Â· æ»šè½®ç¼©æ”¾';
                section.innerHTML = `<div class="placeholder"><div class="icon">ğŸ–¼ï¸</div><div>ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡</div><div class="sub">${subText}</div></div>`;
                section.ondblclick = null;
            }
            initImageSection();
        }

        function updateImageTransform() {
            const img = document.querySelector('#imageSection img');
            if (img) {
                // å…ˆå±…ä¸­(-50%, -50%)ï¼Œå†åº”ç”¨ç”¨æˆ·çš„åç§»å’Œç¼©æ”¾
                img.style.transform = `translate(calc(-50% + ${imgOffsetX}px), calc(-50% + ${imgOffsetY}px)) scale(${imgScale})`;
            }
        }

        function updateBgLayer() {
            const layer = document.getElementById('bgLayer');
            const card = document.getElementById('calendarCard');
            const opacityRow = document.getElementById('bgOpacityRow');
            if (currentBgSrc) {
                layer.innerHTML = `<img src="${currentBgSrc}"><div class="bg-hint">Alt+æ‹–æ‹½ç§»åŠ¨ Â· Alt+æ»šè½®ç¼©æ”¾</div>`;
                updateBgTransform();
                card.classList.add('has-bg');
                opacityRow.style.display = 'flex';
            } else {
                layer.innerHTML = '';
                card.classList.remove('has-bg');
                opacityRow.style.display = 'none';
            }
        }

        function updateBgTransform() {
            const img = document.querySelector('#bgLayer img');
            if (img) {
                img.style.transform = `translate(calc(-50% + ${bgOffsetX}px), calc(-50% + ${bgOffsetY}px)) scale(${bgScale})`;
            }
        }

        function initBgLayer() {
            const card = document.getElementById('calendarCard');

            // Alt + æ‹–æ‹½ç§»åŠ¨èƒŒæ™¯å›¾
            card.addEventListener('mousedown', (e) => {
                if (currentBgSrc && e.altKey && e.button === 0) {
                    isBgDragging = true;
                    bgDragStartX = e.clientX;
                    bgDragStartY = e.clientY;
                    bgStartOffsetX = bgOffsetX;
                    bgStartOffsetY = bgOffsetY;
                    e.preventDefault();
                }
            });

            // Alt + æ»šè½®ç¼©æ”¾èƒŒæ™¯å›¾
            card.addEventListener('wheel', (e) => {
                if (currentBgSrc && e.altKey) {
                    e.preventDefault();
                    const delta = e.deltaY > 0 ? -0.1 : 0.1;
                    bgScale = Math.max(0.5, Math.min(5, bgScale + delta));
                    updateBgTransform();
                }
            }, { passive: false });
        }

        function changeBgOpacity() {
            const value = parseInt(document.getElementById('bgOpacitySlider').value);
            document.getElementById('bgOpacityValue').textContent = value + '%';
            document.documentElement.style.setProperty('--bg-opacity', value / 100);
        }

        function updateBgUploadArea() {
            const area = document.getElementById('bgUpload');
            if (currentBgSrc) {
                area.classList.add('has-image');
                area.innerHTML = `<input type="file" id="bgInput" accept="image/*"><img src="${currentBgSrc}">
                    <div class="upload-actions">
                        <button class="change-btn" onclick="event.stopPropagation();document.getElementById('bgInput').click()">æ¢</button>
                        <button class="delete-btn" onclick="event.stopPropagation();deleteBg()">åˆ </button>
                    </div>`;
            } else {
                area.classList.remove('has-image');
                const isTouchBg = 'ontouchstart' in window;
                const bgSubText = isTouchBg ? 'é•¿æŒ‰æ‹–åŠ¨ Â· åŒæŒ‡ç¼©æ”¾' : 'Alt+æ‹–æ‹½ç§»åŠ¨ Â· Alt+æ»šè½®ç¼©æ”¾';
                area.innerHTML = `<input type="file" id="bgInput" accept="image/*"><div class="icon">ğŸ¨</div><div class="text">ä¸Šä¼ èƒŒæ™¯</div><div class="sub" style="font-size:9px;color:var(--primary-light);opacity:0.7;margin-top:2px;">${bgSubText}</div>`;
            }
            setupBgUpload();
        }

        function deleteBg() {
            currentBgSrc = null;
            updateBgLayer();
            updateBgUploadArea();
        }

        function changeType(el) {
            document.querySelectorAll('.nav-tab').forEach(e => e.classList.remove('active'));
            el.classList.add('active');
            const isWeek = el.dataset.type === 'week';
            const weekSelector = document.getElementById('weekSelector');
            weekSelector.style.display = isWeek ? 'flex' : 'none';
            if (isWeek) {
                const year = parseInt(document.getElementById('year').value);
                const month = parseInt(document.getElementById('month').value);
                updateWeekOptions(year, month);
            }
            updateCalendar();
        }

        let originalImageSize = { width: 0, height: 0 };

        function applyOriginalRatio(el) {
            if (!currentImageSrc || originalImageSize.width === 0) {
                alert('è¯·å…ˆä¸Šä¼ å›¾ç‰‡');
                return;
            }

            document.querySelectorAll('.pill-btn[data-ratio]').forEach(e => e.classList.remove('active'));
            el.classList.add('active');

            const w = originalImageSize.width;
            const h = originalImageSize.height;
            const orient = w >= h ? 'horizontal' : 'vertical';
            currentOrientation = orient;

            if (orient === 'horizontal') {
                cardWidth = 600;
                cardHeight = Math.round(600 * h / w);
            } else {
                cardHeight = 520;
                cardWidth = Math.round(520 * w / h);
            }

            const card = document.getElementById('calendarCard');
            card.classList.remove('horizontal', 'vertical');
            card.classList.add(orient);

            updatePositionButtons();
            applyCardSize();
            syncSizeInputs();
            autoFitPreview();
        }

        function applyCustomRatio() {
            const w = parseInt(document.getElementById('customRatioW').value) || 1;
            const h = parseInt(document.getElementById('customRatioH').value) || 1;

            document.querySelectorAll('.pill-btn[data-ratio]').forEach(e => e.classList.remove('active'));

            const orient = w >= h ? 'horizontal' : 'vertical';
            currentOrientation = orient;

            if (orient === 'horizontal') {
                cardWidth = 600;
                cardHeight = Math.round(600 * h / w);
            } else {
                cardHeight = 520;
                cardWidth = Math.round(520 * w / h);
            }

            const card = document.getElementById('calendarCard');
            card.classList.remove('horizontal', 'vertical');
            card.classList.add(orient);

            updatePositionButtons();
            applyCardSize();
            syncSizeInputs();
            autoFitPreview();
        }

        function changeRatio(el) {
            document.querySelectorAll('.pill-btn[data-ratio]').forEach(e => e.classList.remove('active'));
            el.classList.add('active');

            const ratio = el.dataset.ratio;
            const orient = el.dataset.orient;
            currentOrientation = orient;

            const [w, h] = ratio.split(':').map(Number);
            if (orient === 'horizontal') {
                cardWidth = 600;
                cardHeight = Math.round(600 * h / w);
            } else {
                cardHeight = 520;
                cardWidth = Math.round(520 * w / h);
            }

            const card = document.getElementById('calendarCard');
            card.classList.remove('horizontal', 'vertical');
            card.classList.add(orient);

            updatePositionButtons();
            applyCardSize();
            syncSizeInputs();
        }

        function updatePositionButtons() {
            const btns = document.querySelectorAll('#positionGroup .pill-btn');
            btns.forEach(btn => {
                const pos = btn.dataset.pos;
                if (pos === 'none') {
                    btn.disabled = false; // æ— å›¾é€‰é¡¹å§‹ç»ˆå¯ç”¨
                } else if (currentOrientation === 'horizontal') {
                    btn.disabled = (pos === 'top' || pos === 'bottom');
                    if (btn.disabled && btn.classList.contains('active')) {
                        btn.classList.remove('active');
                        document.querySelector('#positionGroup .pill-btn[data-pos="right"]').classList.add('active');
                        currentPosition = 'right';
                        document.getElementById('calendarCard').dataset.pos = 'right';
                    }
                } else {
                    btn.disabled = (pos === 'left' || pos === 'right');
                    if (btn.disabled && btn.classList.contains('active')) {
                        btn.classList.remove('active');
                        document.querySelector('#positionGroup .pill-btn[data-pos="bottom"]').classList.add('active');
                        currentPosition = 'bottom';
                        document.getElementById('calendarCard').dataset.pos = 'bottom';
                    }
                }
            });
        }

        function changePosition(el) {
            if (el.disabled) return;
            document.querySelectorAll('#positionGroup .pill-btn').forEach(e => e.classList.remove('active'));
            el.classList.add('active');
            currentPosition = el.dataset.pos;
            document.getElementById('calendarCard').dataset.pos = currentPosition;
        }

        function changeStyle(el) {
            document.querySelectorAll('.grid-btn[data-style]').forEach(e => e.classList.remove('active'));
            el.classList.add('active');
            currentStyle = el.dataset.style;
            updateCalendar();
        }

        function toggleDivider() {
            const section = document.querySelector('.calendar-section');
            const checked = document.getElementById('dividerToggle').checked;
            const thicknessWrap = document.getElementById('dividerThicknessWrap');
            if (checked) {
                section.classList.add('has-divider');
                thicknessWrap.style.display = 'flex';
            } else {
                section.classList.remove('has-divider');
                thicknessWrap.style.display = 'none';
            }
        }

        function updateDividerThickness() {
            const value = document.getElementById('dividerThickness').value;
            document.getElementById('dividerThicknessValue').textContent = value + 'px';
            document.documentElement.style.setProperty('--divider-thickness', value + 'px');
        }

        function changeTheme(el) {
            document.querySelectorAll('.color-btn').forEach(e => e.classList.remove('active'));
            document.querySelectorAll('.saved-color').forEach(e => e.classList.remove('active'));
            el.classList.add('active');
            const color = el.dataset.color;
            document.documentElement.style.setProperty('--cal-theme', color);
            document.getElementById('customColor').value = color;
        }

        let savedColors = JSON.parse(localStorage.getItem('calendarSavedColors') || '[]');
        let colorLongPressTimer = null;
        let currentCustomColor = null;

        function changeCustomColor(input) {
            document.querySelectorAll('.color-btn').forEach(e => e.classList.remove('active'));
            document.querySelectorAll('.saved-color').forEach(e => e.classList.remove('active'));
            document.documentElement.style.setProperty('--cal-theme', input.value);
            currentCustomColor = input.value;
        }

        // å½“é¢œè‰²é€‰æ‹©å™¨å…³é—­æ—¶ä¿å­˜é¢œè‰²
        document.getElementById('customColor').addEventListener('change', function() {
            if (currentCustomColor) {
                saveCustomColor(currentCustomColor);
            }
        });

        function saveCustomColor(color) {
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ï¼ˆå¿½ç•¥å¤§å°å†™ï¼‰
            const exists = savedColors.some(c => c.toLowerCase() === color.toLowerCase());
            if (!exists) {
                savedColors.unshift(color);
                if (savedColors.length > 6) savedColors.pop(); // æœ€å¤šä¿å­˜6ä¸ª
                localStorage.setItem('calendarSavedColors', JSON.stringify(savedColors));
                renderSavedColors();
            }
        }

        function renderSavedColors() {
            const container = document.getElementById('savedColors');
            const hint = document.getElementById('savedColorsHint');
            container.innerHTML = savedColors.map((color, i) =>
                `<div class="saved-color" style="background:${color}" data-color="${color}" data-index="${i}" draggable="true"
                    onclick="applySavedColor(this)"
                    onmousedown="startColorLongPress(${i})"
                    onmouseup="cancelColorLongPress()"
                    onmouseleave="cancelColorLongPress()"
                    ontouchstart="startColorLongPress(${i})"
                    ontouchend="cancelColorLongPress()"
                    ondragstart="startColorDrag(event, ${i})"
                    ondragend="endColorDrag(event, ${i})"
></div>`
            ).join('');
            // åªæœ‰æœ‰è‡ªå®šä¹‰é¢œè‰²æ—¶æ‰æ˜¾ç¤ºåˆ é™¤æç¤º
            hint.style.display = savedColors.length > 0 ? 'block' : 'none';
        }

        let draggingColorIndex = -1;

        function startColorDrag(e, index) {
            draggingColorIndex = index;
            e.target.style.opacity = '0.5';
        }

        function endColorDrag(e, index) {
            e.target.style.opacity = '1';
            // æ£€æŸ¥æ˜¯å¦æ‹–å‡ºäº†ä¸»é¢˜è‰²åŒºåŸŸ
            const section = e.target.closest('.section');
            if (section) {
                const rect = section.getBoundingClientRect();
                const x = e.clientX;
                const y = e.clientY;
                // å¦‚æœæ‹–åˆ°åŒºåŸŸå¤–åˆ™åˆ é™¤
                if (x < rect.left || x > rect.right || y < rect.top || y > rect.bottom) {
                    deleteSavedColor(index);
                }
            }
            draggingColorIndex = -1;
        }

        function applySavedColor(el) {
            if (colorLongPressTimer) return; // å¦‚æœæ­£åœ¨é•¿æŒ‰åˆ™ä¸åº”ç”¨
            const color = el.dataset.color;
            document.querySelectorAll('.color-btn').forEach(e => e.classList.remove('active'));
            document.querySelectorAll('.saved-color').forEach(e => e.classList.remove('active'));
            el.classList.add('active');
            document.documentElement.style.setProperty('--cal-theme', color);
            document.getElementById('customColor').value = color;
        }

        function startColorLongPress(index) {
            colorLongPressTimer = setTimeout(() => {
                deleteSavedColor(index);
                colorLongPressTimer = null;
            }, 600); // 600msé•¿æŒ‰è§¦å‘åˆ é™¤
        }

        function cancelColorLongPress() {
            if (colorLongPressTimer) {
                clearTimeout(colorLongPressTimer);
                colorLongPressTimer = null;
            }
        }

        function deleteSavedColor(index) {
            savedColors.splice(index, 1);
            localStorage.setItem('calendarSavedColors', JSON.stringify(savedColors));
            renderSavedColors();
        }

        // ========== è®¾ç½®æ¨¡æ¿ä¿å­˜åŠŸèƒ½ ==========
        let savedSettingsList = JSON.parse(localStorage.getItem('calendarSavedSettings') || '[]');

        function renderSavedSettingsSelect() {
            const select = document.getElementById('savedSettingsSelect');
            select.innerHTML = '<option value="">é€‰æ‹©å·²ä¿å­˜çš„è®¾ç½®...</option>' +
                savedSettingsList.map((s, i) => `<option value="${i}">${s.name}</option>`).join('');

            // æ›´æ–°è‡ªå®šä¹‰ä¸‹æ‹‰æ¡†
            const dropdown = document.getElementById('settingsSelectDropdown');
            if (dropdown) {
                dropdown.innerHTML = '<div class="custom-select-option settings-placeholder" data-value="" onclick="selectSettingsOption(\'\', \'\')">é€‰æ‹©å·²ä¿å­˜çš„è®¾ç½®...</div>' +
                    savedSettingsList.map((s, i) =>
                        `<div class="custom-select-option" data-value="${i}" onclick="selectSettingsOption('${i}', '${s.name.replace(/'/g, "\\'")}')">${s.name}</div>`
                    ).join('');
            }
            // é‡ç½®æ˜¾ç¤ºæ–‡å­—
            document.getElementById('settingsSelectText').textContent = 'é€‰æ‹©å·²ä¿å­˜çš„è®¾ç½®...';
        }

        function showSaveSettingsDialog() {
            document.getElementById('settingsName').value = '';
            document.getElementById('saveDialogOverlay').classList.add('show');
            document.getElementById('settingsName').focus();
        }

        function closeSaveDialog(e) {
            if (!e || e.target === document.getElementById('saveDialogOverlay')) {
                document.getElementById('saveDialogOverlay').classList.remove('show');
            }
        }

        function confirmSaveSettings() {
            const name = document.getElementById('settingsName').value.trim();
            if (!name) {
                alert('è¯·è¾“å…¥è®¾ç½®åç§°');
                return;
            }

            // æ”¶é›†å½“å‰æ‰€æœ‰è®¾ç½®
            const settings = {
                name: name,
                cardWidth: cardWidth,
                cardHeight: cardHeight,
                orientation: currentOrientation,
                position: currentPosition,
                style: currentStyle,
                themeColor: getComputedStyle(document.documentElement).getPropertyValue('--cal-theme').trim(),
                font: document.getElementById('calendarFont').value,
                fontSize: document.getElementById('fontSizeSlider').value,
                footerText: document.getElementById('footerText').value,
                sizeUnit: sizeUnit,
                hasDivider: document.getElementById('dividerToggle').checked,
                dividerThickness: document.getElementById('dividerThickness').value
            };

            savedSettingsList.unshift(settings);
            if (savedSettingsList.length > 10) savedSettingsList.pop(); // æœ€å¤šä¿å­˜10ä¸ª
            localStorage.setItem('calendarSavedSettings', JSON.stringify(savedSettingsList));
            renderSavedSettingsSelect();
            closeSaveDialog();
        }

        function loadSavedSettings() {
            const select = document.getElementById('savedSettingsSelect');
            const index = select.value;
            if (index === '') return;

            const s = savedSettingsList[parseInt(index)];
            if (!s) return;

            // æ¢å¤è®¾ç½®
            cardWidth = s.cardWidth;
            cardHeight = s.cardHeight;
            currentOrientation = s.orientation;
            currentPosition = s.position;
            currentStyle = s.style;
            sizeUnit = s.sizeUnit || 'px';
            fontSizeMultiplier = (parseInt(s.fontSize) || 100) / 100;

            // æ›´æ–°UI
            document.getElementById('sizeUnit').value = sizeUnit;
            syncSizeInputs();

            // æ–¹å‘å’Œä½ç½®
            const card = document.getElementById('calendarCard');
            card.classList.remove('horizontal', 'vertical');
            card.classList.add(currentOrientation);
            card.dataset.pos = currentPosition;
            updatePositionButtons();
            document.querySelectorAll('#positionGroup .pill-btn').forEach(e => {
                e.classList.toggle('active', e.dataset.pos === currentPosition);
            });

            // æ ·å¼
            document.querySelectorAll('.grid-btn[data-style]').forEach(e => {
                e.classList.toggle('active', e.dataset.style === currentStyle);
            });

            // ä¸»é¢˜è‰²
            document.documentElement.style.setProperty('--cal-theme', s.themeColor);
            document.getElementById('customColor').value = s.themeColor;
            document.querySelectorAll('.color-btn').forEach(e => {
                e.classList.toggle('active', e.dataset.color === s.themeColor);
            });

            // å­—ä½“
            document.getElementById('calendarFont').value = s.font;
            document.documentElement.style.setProperty('--calendar-font', s.font);
            updateFontDropdownSelection(s.font);

            // å­—ä½“å¤§å°
            document.getElementById('fontSizeSlider').value = s.fontSize;
            document.getElementById('fontSizeValue').textContent = s.fontSize + '%';

            // åº•éƒ¨æ–‡å­—
            document.getElementById('footerText').value = s.footerText;
            document.getElementById('cardFooter').textContent = s.footerText;

            // åˆ†éš”çº¿
            const dividerToggle = document.getElementById('dividerToggle');
            dividerToggle.checked = s.hasDivider || false;
            if (s.dividerThickness) {
                document.getElementById('dividerThickness').value = s.dividerThickness;
                document.getElementById('dividerThicknessValue').textContent = s.dividerThickness + 'px';
                document.documentElement.style.setProperty('--divider-thickness', s.dividerThickness + 'px');
            }
            toggleDivider();

            applyCardSize();
            autoFitPreview();
            updateCalendar();

            // é‡ç½®é€‰æ‹©æ¡†
            select.value = '';
        }

        function deleteSavedSettings() {
            const select = document.getElementById('savedSettingsSelect');
            const index = select.value;
            if (index === '') {
                alert('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„è®¾ç½®');
                return;
            }

            const name = savedSettingsList[parseInt(index)].name;
            if (confirm(`ç¡®å®šè¦åˆ é™¤è®¾ç½®"${name}"å—ï¼Ÿ`)) {
                savedSettingsList.splice(parseInt(index), 1);
                localStorage.setItem('calendarSavedSettings', JSON.stringify(savedSettingsList));
                renderSavedSettingsSelect();
            }
        }

        function updateSliders() {
            // æ»‘å—å§‹ç»ˆä½¿ç”¨åƒç´ å€¼
            document.getElementById('widthSlider').value = cardWidth;
            document.getElementById('heightSlider').value = cardHeight;
        }

        function updateFromSlider(type) {
            // æ»‘å—å€¼æ˜¯åƒç´ ï¼Œç›´æ¥è®¾ç½®
            if (type === 'width') {
                cardWidth = parseInt(document.getElementById('widthSlider').value);
            } else {
                cardHeight = parseInt(document.getElementById('heightSlider').value);
            }
            syncSizeInputs();
            applyCardSize();
        }

        function changeFont() {
            const font = document.getElementById('calendarFont').value;
            document.documentElement.style.setProperty('--calendar-font', font);
        }

        function changeFontSize() {
            const value = parseInt(document.getElementById('fontSizeSlider').value);
            fontSizeMultiplier = value / 100;
            document.getElementById('fontSizeValue').textContent = value + '%';
            applyCardSize();
        }

        function updateFooter() {
            document.getElementById('cardFooter').textContent = document.getElementById('footerText').value;
        }

        let lastWeekYear = 0, lastWeekMonth = 0;

        function updateCalendar() {
            const type = document.querySelector('.nav-tab.active').dataset.type;
            const year = parseInt(document.getElementById('year').value);
            const month = parseInt(document.getElementById('month').value);

            // åªåœ¨å¹´æœˆå˜åŒ–æ—¶æ‰æ›´æ–°å‘¨é€‰é¡¹ï¼Œé¿å…é‡ç½®ç”¨æˆ·çš„å‘¨é€‰æ‹©
            if (type === 'week' && (year !== lastWeekYear || month !== lastWeekMonth)) {
                updateWeekOptions(year, month);
                lastWeekYear = year;
                lastWeekMonth = month;
            }

            document.getElementById('yearMonthDisplay').textContent = `${year}å¹´${month}æœˆ`;
            if (currentStyle === 'full') {
                try {
                    const lunar = Lunar.fromDate(new Date(year, month - 1, 15));
                    document.getElementById('lunarMonthDisplay').textContent = `${lunar.getYearInChinese()}å¹´ ${lunar.getMonthInChinese()}æœˆ`;
                } catch (e) { }
            }

            if (type === 'month') generateMonthCalendar(year, month);
            else generateWeekCalendar(year, month, parseInt(document.getElementById('weekNumber').value) || 1);
        }

        function updateWeekOptions(year, month) {
            const select = document.getElementById('weekNumber');
            select.innerHTML = '';
            const firstDay = new Date(year, month - 1, 1);
            const lastDay = new Date(year, month, 0);
            let current = new Date(firstDay);
            while (current.getDay() !== 1) current.setDate(current.getDate() - 1);
            let wc = 0;
            while (current <= lastDay || wc === 0) {
                wc++;
                const s = new Date(current);
                const e = new Date(current);
                e.setDate(e.getDate() + 6);
                const opt = document.createElement('option');
                opt.value = wc;
                opt.textContent = `ç¬¬${wc}å‘¨ (${s.getMonth() + 1}/${s.getDate()}-${e.getMonth() + 1}/${e.getDate()})`;
                select.appendChild(opt);
                current.setDate(current.getDate() + 7);
                if (wc > 6) break;
            }
        }

        function generateMonthCalendar(year, month) {
            const grid = document.getElementById('calendarGrid');
            let classes = 'month-grid';
            if (currentStyle === 'solar') classes += ' solar-only';
            if (currentStyle === 'note') classes += ' note-style';
            grid.className = classes;
            grid.innerHTML = '';

            ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'].forEach((d, i) => {
                const h = document.createElement('div');
                h.className = 'weekday-header' + (i === 0 || i === 6 ? ' weekend' : '');
                h.textContent = d;
                grid.appendChild(h);
            });

            const firstDay = new Date(year, month - 1, 1);
            const lastDay = new Date(year, month, 0);
            const startDay = firstDay.getDay();
            const totalDays = lastDay.getDate();
            const prevLast = new Date(year, month - 1, 0).getDate();

            for (let i = startDay - 1; i >= 0; i--) grid.appendChild(createDayCell(year, month - 1, prevLast - i, true));
            for (let d = 1; d <= totalDays; d++) grid.appendChild(createDayCell(year, month, d, false));
            const rem = 42 - (startDay + totalDays);
            for (let d = 1; d <= rem; d++) grid.appendChild(createDayCell(year, month + 1, d, true));
        }

        function createDayCell(year, month, day, isOther) {
            const cell = document.createElement('div');
            cell.className = 'day-cell';
            if (isOther) cell.classList.add('other-month');

            let y = year, m = month;
            if (m < 1) { y--; m = 12; }
            if (m > 12) { y++; m = 1; }

            const date = new Date(y, m - 1, day);
            const dow = date.getDay();
            if (dow === 0 || dow === 6) cell.classList.add('weekend');

            const solar = document.createElement('div');
            solar.className = 'solar';
            solar.textContent = day;
            cell.appendChild(solar);

            if (currentStyle === 'full') {
                try {
                    const lunar = Lunar.fromDate(date);
                    const ld = document.createElement('div');
                    ld.className = 'lunar';
                    const f = lunar.getFestivals();
                    const jq = lunar.getJieQi();
                    const sf = Solar.fromDate(date).getFestivals();
                    if (sf.length) { ld.textContent = sf[0].substring(0, 3); ld.classList.add('festival'); }
                    else if (f.length) { ld.textContent = f[0].substring(0, 3); ld.classList.add('festival'); }
                    else if (jq) { ld.textContent = jq; ld.classList.add('jieqi'); }
                    else if (lunar.getDay() === 1) { ld.textContent = lunar.getMonthInChinese() + 'æœˆ'; }
                    else { ld.textContent = lunar.getDayInChinese(); }
                    cell.appendChild(ld);
                } catch (e) { }
            }

            if (currentStyle === 'note' && !isOther) {
                const inp = document.createElement('input');
                inp.type = 'text';
                inp.className = 'note-input';
                inp.onclick = e => e.stopPropagation();
                cell.appendChild(inp);
            }

            return cell;
        }

        function generateWeekCalendar(year, month, weekNum) {
            const grid = document.getElementById('calendarGrid');
            let classes = 'week-grid';
            if (currentStyle === 'solar') classes += ' solar-only';
            grid.className = classes;
            grid.innerHTML = '';

            const firstDay = new Date(year, month - 1, 1);
            let current = new Date(firstDay);
            while (current.getDay() !== 1) current.setDate(current.getDate() - 1);
            current.setDate(current.getDate() + (weekNum - 1) * 7);

            const names = ['å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­', 'å‘¨æ—¥'];
            for (let i = 0; i < 7; i++) {
                const date = new Date(current);
                date.setDate(date.getDate() + i);
                const row = document.createElement('div');
                row.className = 'week-day-row';
                const dow = date.getDay();
                if (dow === 0 || dow === 6) row.classList.add('weekend');
                row.innerHTML = `<div class="week-day-name">${names[i]}</div><div class="week-solar">${date.getDate()}</div>`;

                if (currentStyle === 'full') {
                    try {
                        const lunar = Lunar.fromDate(date);
                        let txt = lunar.getMonthInChinese() + 'æœˆ' + lunar.getDayInChinese();
                        const f = lunar.getFestivals();
                        const jq = lunar.getJieQi();
                        if (f.length) txt += ' Â· ' + f[0];
                        else if (jq) txt += ' Â· ' + jq;
                        row.innerHTML += `<div class="week-lunar">${txt}</div>`;
                    } catch (e) { }
                }
                grid.appendChild(row);
            }
        }

        function exportImage() {
            const card = document.getElementById('calendarCard');
            const container = document.getElementById('canvasContainer');
            const format = document.getElementById('exportFormat').value;
            const scale = parseInt(document.getElementById('exportScale').value);

            const hint = card.querySelector('.image-hint');
            const resizeHint = container.querySelector('.resize-hint');
            if (hint) hint.style.display = 'none';
            if (resizeHint) resizeHint.style.display = 'none';

            document.querySelectorAll('.resize-handle').forEach(el => el.style.display = 'none');

            // ä¸´æ—¶ç§»é™¤é¢„è§ˆç¼©æ”¾
            const originalTransform = container.style.transform;
            container.style.transform = 'none';

            // ä¸´æ—¶ç§»é™¤è¾¹æ¡†ï¼ˆè¾¹æ¡†ä»…ç”¨äºé¢„è§ˆï¼‰
            card.style.setProperty('border', 'none', 'important');

            // è·å–å®é™…æ¸²æŸ“å°ºå¯¸
            const actualWidth = card.offsetWidth;
            const actualHeight = card.offsetHeight;

            // ç­‰å¾…é‡ç»˜åå†æˆªå›¾ï¼ˆåŒé‡RAFç¡®ä¿æ ·å¼ç”Ÿæ•ˆï¼‰
            requestAnimationFrame(() => {
            requestAnimationFrame(() => {
                html2canvas(card, {
                    scale: scale,
                    useCORS: true,
                    allowTaint: true,
                    backgroundColor: format === 'jpeg' ? '#ffffff' : null,
                    width: actualWidth,
                    height: actualHeight,
                    windowWidth: actualWidth,
                    windowHeight: actualHeight,
                    logging: false,
                    imageTimeout: 0,
                    onclone: function(clonedDoc) {
                        // ç¡®ä¿å…‹éš†çš„å…ƒç´ ä¿æŒæ­£ç¡®å°ºå¯¸
                        const clonedCard = clonedDoc.getElementById('calendarCard');
                        if (clonedCard) {
                            clonedCard.style.width = actualWidth + 'px';
                            clonedCard.style.height = actualHeight + 'px';
                            clonedCard.style.transform = 'none';
                            clonedCard.style.border = 'none';
                        }
                        // ç¡®ä¿å›¾ç‰‡ä¿æŒæ­£ç¡®çš„transform
                        const clonedImg = clonedDoc.querySelector('#imageSection img');
                        const originalImg = document.querySelector('#imageSection img');
                        if (clonedImg && originalImg) {
                            clonedImg.style.cssText = originalImg.style.cssText;
                            clonedImg.style.position = 'absolute';
                            clonedImg.style.top = '50%';
                            clonedImg.style.left = '50%';
                            clonedImg.style.minWidth = '100%';
                            clonedImg.style.minHeight = '100%';
                            clonedImg.style.width = 'auto';
                            clonedImg.style.height = 'auto';
                        }
                        // ç¡®ä¿å›¾ç‰‡åŒºåŸŸå°ºå¯¸æ­£ç¡®
                        const clonedImgSection = clonedDoc.getElementById('imageSection');
                        const originalImgSection = document.getElementById('imageSection');
                        if (clonedImgSection && originalImgSection) {
                            clonedImgSection.style.width = originalImgSection.offsetWidth + 'px';
                            clonedImgSection.style.height = originalImgSection.offsetHeight + 'px';
                            clonedImgSection.style.flexShrink = '0';
                        }
                        // ç¡®ä¿æ—¥å†åŒºåŸŸå°ºå¯¸æ­£ç¡®
                        const clonedCalSection = clonedDoc.getElementById('calendarSection');
                        const originalCalSection = document.getElementById('calendarSection');
                        if (clonedCalSection && originalCalSection) {
                            clonedCalSection.style.width = originalCalSection.offsetWidth + 'px';
                            clonedCalSection.style.height = originalCalSection.offsetHeight + 'px';
                            clonedCalSection.style.flexShrink = '0';
                        }
                        // ç¡®ä¿èƒŒæ™¯å›¾ä¿æŒæ­£ç¡®çš„transform
                        const clonedBgImg = clonedDoc.querySelector('#bgLayer img');
                        const originalBgImg = document.querySelector('#bgLayer img');
                        if (clonedBgImg && originalBgImg) {
                            clonedBgImg.style.cssText = originalBgImg.style.cssText;
                            clonedBgImg.style.position = 'absolute';
                            clonedBgImg.style.top = '50%';
                            clonedBgImg.style.left = '50%';
                            clonedBgImg.style.minWidth = '100%';
                            clonedBgImg.style.minHeight = '100%';
                            clonedBgImg.style.width = 'auto';
                            clonedBgImg.style.height = 'auto';
                        }
                    }
                }).then(canvas => {
                    // æ¢å¤é¢„è§ˆç¼©æ”¾å’Œè¾¹æ¡†
                    container.style.transform = originalTransform;
                    card.style.removeProperty('border');
                    if (hint) hint.style.display = '';
                    if (resizeHint) resizeHint.style.display = '';
                    document.querySelectorAll('.resize-handle').forEach(el => el.style.display = '');

                    const link = document.createElement('a');
                    const y = document.getElementById('year').value;
                    const m = document.getElementById('month').value;
                    const pixelWidth = Math.round(actualWidth * scale);
                    const pixelHeight = Math.round(actualHeight * scale);

                    if (format === 'svg') {
                        // SVGå¯¼å‡ºï¼šå°†canvasè½¬ä¸ºPNGååµŒå…¥SVG
                        const dataUrl = canvas.toDataURL('image/png', 1.0);
                        const svgContent = '<?xml version="1.0" encoding="UTF-8"?>\n<svg xmlns="http://www.w3.org/2000/svg" width="' + pixelWidth + '" height="' + pixelHeight + '" viewBox="0 0 ' + pixelWidth + ' ' + pixelHeight + '">\n  <image width="' + pixelWidth + '" height="' + pixelHeight + '" href="' + dataUrl + '"/>\n</svg>';
                        const blob = new Blob([svgContent], { type: 'image/svg+xml;charset=utf-8' });
                        link.download = `æ—¥å†_${y}å¹´${m}æœˆ_${pixelWidth}x${pixelHeight}px.svg`;
                        link.href = URL.createObjectURL(blob);
                    } else {
                        const ext = format === 'jpeg' ? 'jpg' : 'png';
                        link.download = `æ—¥å†_${y}å¹´${m}æœˆ_${pixelWidth}x${pixelHeight}px.${ext}`;
                        link.href = canvas.toDataURL(`image/${format}`, 1.0);
                    }
                    link.click();
                }).catch(err => {
                    console.error('å¯¼å‡ºå¤±è´¥:', err);
                    alert('å¯¼å‡ºå¤±è´¥ï¼Œè¯·é‡è¯•');
                    // æ¢å¤é¢„è§ˆç¼©æ”¾å’Œè¾¹æ¡†
                    container.style.transform = originalTransform;
                    card.style.removeProperty('border');
                    if (hint) hint.style.display = '';
                    if (resizeHint) resizeHint.style.display = '';
                    document.querySelectorAll('.resize-handle').forEach(el => el.style.display = '');
                });
            });
            });
        }

        // ========== æ’¤å›/å‰è¿›åŠŸèƒ½ ==========
        let historyStack = [];
        let redoStack = [];
        const MAX_HISTORY = 20;

        function getCurrentState() {
            return {
                cardWidth,
                cardHeight,
                currentOrientation,
                currentPosition,
                currentStyle,
                themeColor: getComputedStyle(document.documentElement).getPropertyValue('--cal-theme').trim(),
                font: document.getElementById('calendarFont').value,
                fontSize: document.getElementById('fontSizeSlider').value,
                footerText: document.getElementById('footerText').value,
                imgScale,
                imgOffsetX,
                imgOffsetY
            };
        }

        function saveState() {
            const state = getCurrentState();
            if (historyStack.length > 0) {
                const last = historyStack[historyStack.length - 1];
                if (JSON.stringify(last) === JSON.stringify(state)) return;
            }
            historyStack.push(state);
            if (historyStack.length > MAX_HISTORY) historyStack.shift();
            redoStack = [];
            updateUndoRedoButtons();
        }

        function restoreState(state) {
            cardWidth = state.cardWidth;
            cardHeight = state.cardHeight;
            currentOrientation = state.currentOrientation;
            currentPosition = state.currentPosition;
            currentStyle = state.currentStyle;
            imgScale = state.imgScale;
            imgOffsetX = state.imgOffsetX;
            imgOffsetY = state.imgOffsetY;
            fontSizeMultiplier = (parseInt(state.fontSize) || 100) / 100;

            syncSizeInputs();
            const card = document.getElementById('calendarCard');
            card.classList.remove('horizontal', 'vertical');
            card.classList.add(currentOrientation);
            card.dataset.pos = currentPosition;
            updatePositionButtons();

            document.querySelectorAll('.grid-btn[data-style]').forEach(e => {
                e.classList.toggle('active', e.dataset.style === currentStyle);
            });

            document.documentElement.style.setProperty('--cal-theme', state.themeColor);
            document.getElementById('customColor').value = state.themeColor;

            document.getElementById('calendarFont').value = state.font;
            document.documentElement.style.setProperty('--calendar-font', state.font);
            updateFontDropdownSelection(state.font);

            document.getElementById('fontSizeSlider').value = state.fontSize;
            document.getElementById('fontSizeValue').textContent = state.fontSize + '%';

            document.getElementById('footerText').value = state.footerText;
            document.getElementById('cardFooter').textContent = state.footerText;

            updateImageTransform();
            applyCardSize();
            updateCalendar();
        }

        function undo() {
            if (historyStack.length <= 1) return;
            const current = historyStack.pop();
            redoStack.push(current);
            const prev = historyStack[historyStack.length - 1];
            restoreState(prev);
            updateUndoRedoButtons();
        }

        function redo() {
            if (redoStack.length === 0) return;
            const state = redoStack.pop();
            historyStack.push(state);
            restoreState(state);
            updateUndoRedoButtons();
        }

        function updateUndoRedoButtons() {
            const undoBtn = document.getElementById('undoBtn');
            const redoBtn = document.getElementById('redoBtn');
            undoBtn.disabled = historyStack.length <= 1;
            redoBtn.disabled = redoStack.length === 0;
            undoBtn.style.opacity = undoBtn.disabled ? '0.4' : '1';
            redoBtn.style.opacity = redoBtn.disabled ? '0.4' : '1';
        }

        // åŒ…è£…å‡½æ•°ä»¥åœ¨æ“ä½œåä¿å­˜çŠ¶æ€
        const _changeRatio = changeRatio;
        changeRatio = function(el) { _changeRatio(el); saveState(); };

        const _changePosition = changePosition;
        changePosition = function(el) { _changePosition(el); saveState(); };

        const _changeStyle = changeStyle;
        changeStyle = function(el) { _changeStyle(el); saveState(); };

        const _changeTheme = changeTheme;
        changeTheme = function(el) { _changeTheme(el); saveState(); };

        const _changeFont = changeFont;
        changeFont = function() { _changeFont(); saveState(); };

        const _handleMouseUp = handleMouseUp;
        handleMouseUp = function() {
            const wasDragging = isDragging;
            const wasResizing = isResizing;
            _handleMouseUp();
            if (wasDragging || wasResizing) saveState();
        };

        setTimeout(() => { saveState(); }, 200);
    </script>
</body>
</html>
